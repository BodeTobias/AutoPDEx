<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>autopdex.dae &mdash; AutoPDEx  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/dark_mode_css/general.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/dark_mode_css/dark.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="../../_static/dark_mode_js/default_light.js"></script>
        <script src="../../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AutoPDEx
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/quickstart.html">Quickstart to AutoPDEx</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">High level operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../solver.html">Solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dae.html">Time stepping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../example_notebooks.html">Example notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examplary input files</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Settings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html">Settings and static_settings</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lower level operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../assembler.html">Assembler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implicit_diff.html">Implicit_diff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spaces.html">Spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solution_structures.html">Solution structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../variational_schemes.html">Variational_schemes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pre- and postprocessing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../geometry.html">Geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../seeder.html">Seeder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utility.html">Utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotter.html">Plotter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mesher.html">Mesher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Source code</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/BodeTobias/AutoPDEx">GitHub Project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AutoPDEx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">autopdex.dae</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for autopdex.dae</h1><div class="highlight"><pre>
<span></span><span class="c1"># dae.py</span>
<span class="c1"># Copyright (C) 2025 Tobias Bode</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>

<span class="sd">&quot;&quot;&quot;Module for solving differential algebraic systems and transient PDEs.&quot;&quot;&quot;</span>

<span class="c1"># TODO: make sure, the integrator supports changing the step size if neccessarry! e.g. adams moulton: root iteration controler not possible...</span>
<span class="c1"># TODO: generate tests from examples</span>
<span class="c1"># TODO: translate all comments to english</span>
<span class="c1"># TODO: staggered policies, explicit diagonal modes</span>
<span class="c1"># TODO: add information about algebraic equations and add different treatements, e.g. projection for explicit modes</span>


<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.csgraph</span> <span class="kn">import</span> <span class="n">connected_components</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">tree_util</span><span class="p">,</span> <span class="n">custom_jvp</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">sparse</span>

<span class="kn">from</span> <span class="nn">autopdex.utility</span> <span class="kn">import</span> <span class="n">dict_flatten</span><span class="p">,</span> <span class="n">reshape_as</span><span class="p">,</span> <span class="n">jit_with_docstring</span>
<span class="kn">from</span> <span class="nn">autopdex</span> <span class="kn">import</span> <span class="n">solver</span><span class="p">,</span> <span class="n">assembler</span><span class="p">,</span> <span class="n">implicit_diff</span>



<span class="c1">## helper functions</span>

<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">_no_derivative</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">q</span>

<span class="nd">@_no_derivative</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">_no_derivative_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Your chosen integrator does not support derivatives up to the order you are using!</span><span class="se">\</span>
<span class="s2">    Consider using a different integrator or convert your system to a system of lower order.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="discrete_value_with_derivatives"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.discrete_value_with_derivatives.html#autopdex.dae.discrete_value_with_derivatives">[docs]</a><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_derivs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Evaluate the discrete state value with custom derivative propagation.</span>

<span class="sd">  This function returns the discrete state value `q`, but it is equipped with a custom Jacobian-vector product (JVP)</span>
<span class="sd">  rule to correctly propagate derivative information through discrete operations. This custom derivative rule is designed</span>
<span class="sd">  to support higher-order derivative calculations by processing a sequence of derivative values provided in `q_derivs`.</span>

<span class="sd">  In the absence of derivative information (i.e. when `q_derivs` is empty), the derivative is taken to be `q_dot`.</span>
<span class="sd">  When derivative information is available, the first derivative in `q_derivs` is used recursively along with the time</span>
<span class="sd">  derivative `t_dot` to compute the overall derivative contribution.</span>

<span class="sd">  It is used to construct a differentiable q_fun based on a value and its derivative defined by an integration rule, e.g.:</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">    </span>
<span class="sd">      def diffable_q_fun(t): # q_ts is a tuple of (q, q_t, q_tt, ...) coming from the integrator</span>
<span class="sd">        return {key: discrete_value_with_derivatives(t, q_ts[key][0], q_ts[key][1:]) for key in template.keys()}</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    t: Scalar representing the time variable.</span>
<span class="sd">    q: The discrete state value.</span>
<span class="sd">    q_derivs: A sequence (e.g., list or tuple) of derivative values corresponding to `q`. The first element represents</span>
<span class="sd">              the first derivative, with subsequent elements (if any) representing higher-order derivatives.</span>
<span class="sd">  </span>
<span class="sd">  Returns:</span>
<span class="sd">    The discrete state value `q`. The custom derivative rule ensures that during differentiation the returned derivative follows the form:</span>
<span class="sd">    </span>
<span class="sd">      - If no derivative information is provided (`q_derivs` is empty): returns `q_dot`.</span>
<span class="sd">      - Otherwise: returns `q_dot + (discrete_value_with_derivatives(t, first_deriv, remaining_derivs) * t_dot)`,</span>
<span class="sd">        where `first_deriv` is the first element of `q_derivs` and `remaining_derivs` contains any higher-order derivatives.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">q</span></div>

<span class="nd">@discrete_value_with_derivatives</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">discrete_value_with_derivatives_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_derivs</span><span class="p">)</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="p">(</span><span class="n">t_dot</span><span class="p">,</span> <span class="n">q_dot</span><span class="p">,</span> <span class="n">q_derivs_dot</span><span class="p">)</span> <span class="o">=</span> <span class="n">tangents</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_derivs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># return _no_derivative(t, q), q_dot # Problematic with multiple fields?!</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_dot</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">first_derivs</span> <span class="o">=</span> <span class="n">q_derivs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">remaining_derivs</span> <span class="o">=</span> <span class="n">q_derivs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_derivs</span><span class="p">),</span> <span class="n">q_dot</span> <span class="o">+</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">first_derivs</span><span class="p">,</span> <span class="n">remaining_derivs</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_dot</span>


<span class="c1">## butcher tableau inversion</span>

<div class="viewcode-block" id="detect_stage_dependencies"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.detect_stage_dependencies.html#autopdex.dae.detect_stage_dependencies">[docs]</a><span class="k">def</span> <span class="nf">detect_stage_dependencies</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Detects coupled structures (strongly connected components) in the Butcher matrix A and identifies explicit stages.</span>

<span class="sd">  Parameters:</span>
<span class="sd">    A (ndarray): Butcher matrix of stage coefficients (s x s).</span>

<span class="sd">  Returns:</span>
<span class="sd">    stage_blocks (list): A list of lists containing the indices of coupled stages.</span>
<span class="sd">    explicit_stages (list): A list of indices corresponding to explicit stages.</span>
<span class="sd">    block_dependencies (dict): A dictionary mapping each block to its dependent blocks.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">dependency_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

  <span class="c1"># Find SCCs</span>
  <span class="n">graph</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">dependency_matrix</span><span class="p">)</span>
  <span class="n">n_components</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">connected_components</span><span class="p">(</span><span class="n">csgraph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="s1">&#39;strong&#39;</span><span class="p">)</span>

  <span class="c1"># Group stages by their SCC labels</span>
  <span class="n">stage_blocks</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">stage_blocks</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

  <span class="c1"># Explicit stages: a_ii = 0</span>
  <span class="n">explicit_stages</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">stage_blocks</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">block</span><span class="p">):</span>  <span class="c1"># Alle Diagonalelemente in diesem Block sind 0</span>
      <span class="n">explicit_stages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

  <span class="c1"># Set up block dependencies</span>
  <span class="n">block_dependencies</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)}</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">dependency_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
        <span class="n">block_i</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">block_j</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">block_i</span> <span class="o">!=</span> <span class="n">block_j</span><span class="p">:</span>
          <span class="n">block_dependencies</span><span class="p">[</span><span class="n">block_i</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block_j</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">stage_blocks</span><span class="p">,</span> <span class="n">explicit_stages</span><span class="p">,</span> <span class="n">block_dependencies</span></div>

<div class="viewcode-block" id="invert_butcher_with_order"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.invert_butcher_with_order.html#autopdex.dae.invert_butcher_with_order">[docs]</a><span class="k">def</span> <span class="nf">invert_butcher_with_order</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Computes the blockwise linear mapping matrix ``A_`` that maps U to U_dot without inter-block coupling,</span>
<span class="sd">  and determines the execution order of the blocks.</span>

<span class="sd">  Parameters:</span>
<span class="sd">    ``A`` (ndarray): Butcher matrix of stage coefficients (s x s).</span>

<span class="sd">  Returns:</span>
<span class="sd">    ``A_`` (ndarray): Matrix mapping U to U_dot (s x s).</span>
<span class="sd">    execution_order (list): ``A`` list specifying the order of operations (blocks or explicit stage indices).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">A_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># Initialize resulting matrix</span>

  <span class="c1"># Detect explicit stages and coupled blocks</span>
  <span class="n">stage_blocks</span><span class="p">,</span> <span class="n">explicit_stages</span><span class="p">,</span> <span class="n">block_dependencies</span> <span class="o">=</span> <span class="n">detect_stage_dependencies</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">stage_blocks</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">explicit_stages</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">block</span><span class="p">):</span>  <span class="c1"># Explicit stages</span>
      <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Coupled blocks</span>
      <span class="n">A_block</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">block</span><span class="p">)]</span>
      <span class="n">A_block_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_block</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
          <span class="n">A_</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_block_inv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

  <span class="c1"># Explicit stages: set diagonal to 1 and invert the sign of the lower triangle</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">explicit_stages</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
      <span class="n">A_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">A_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># Determine ordering of the blocks</span>
  <span class="n">execution_order</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">resolved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">resolve_block</span><span class="p">(</span><span class="n">block_idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">block_idx</span> <span class="ow">in</span> <span class="n">resolved</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">block_dependencies</span><span class="p">[</span><span class="n">block_idx</span><span class="p">]:</span>
      <span class="n">resolve_block</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
    <span class="n">resolved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block_idx</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">stage_blocks</span><span class="p">[</span><span class="n">block_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">explicit_stages</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">block</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
        <span class="n">execution_order</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;explicit&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">execution_order</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">block</span><span class="p">,</span> <span class="s2">&quot;implicit&quot;</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">block_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_blocks</span><span class="p">)):</span>
    <span class="n">resolve_block</span><span class="p">(</span><span class="n">block_idx</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">A_</span><span class="p">,</span> <span class="n">execution_order</span></div>


<span class="c1">## integrator class</span>

<div class="viewcode-block" id="TimeIntegrator"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeIntegrator.html#autopdex.dae.TimeIntegrator">[docs]</a><span class="k">class</span> <span class="nc">TimeIntegrator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Base class for time integrators.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeIntegrator.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeIntegrator.html#autopdex.dae.TimeIntegrator.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">name</span><span class="p">,</span>
               <span class="n">value_and_derivatives</span><span class="p">,</span>
               <span class="n">update</span><span class="p">,</span>
               <span class="n">stage_list</span><span class="p">,</span>
               <span class="n">stage_types</span><span class="p">,</span>
               <span class="n">stage_positions</span><span class="p">,</span>
               <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the time integrator.</span>

<span class="sd">    Parameters:</span>
<span class="sd">      name (str): The name of the method.</span>
<span class="sd">      value_and_derivatives (callable): Function to compute state values and their derivatives.</span>
<span class="sd">      update (callable): Function that updates the state based on stage results.</span>
<span class="sd">      stage_list (ndarray): Array containing the indices or order of stages.</span>
<span class="sd">      stage_types (tuple): Tuple indicating the type of each stage (&#39;explicit&#39; or &#39;implicit&#39;).</span>
<span class="sd">      stage_positions (ndarray): Array of stage positions (e.g., Butcher nodes).</span>
<span class="sd">      num_steps (int): Number of previous steps (for multi-step methods).</span>
<span class="sd">      num_derivs (int): Highest derivative order that is supported.</span>
<span class="sd">      num_stages (int): Number of stages (e.g., in Rungeâ€“Kutta methods).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span> <span class="o">=</span> <span class="n">value_and_derivatives</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="n">update</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_list</span> <span class="o">=</span> <span class="n">stage_list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_types</span> <span class="o">=</span> <span class="n">stage_types</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_positions</span> <span class="o">=</span> <span class="n">stage_positions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">num_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_derivs</span> <span class="o">=</span> <span class="n">num_derivs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updating rule after solving the step.</span>

<span class="sd">    This method must be implemented by concrete integrator classes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">      q_stages: Results from the solve, stage results</span>
<span class="sd">      q_n: Values of last time steps</span>
<span class="sd">      q_t_n: Derivatives of last time steps</span>
<span class="sd">      dt: Step size</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple containing the updated state and derivative.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the function value and temporal derivative for an integrator, e.g. q, (q-q_n[0])/dt for backward Euler.</span>

<span class="sd">    Parameters:</span>
<span class="sd">      q: Values of the stages that are to be determined.</span>
<span class="sd">      q_n: Values of last time steps. q_n[0] is of time n, q_n[1] of time n-1, etc.</span>
<span class="sd">      q_t_n: Derivatives at last time steps. q_t_n[i, j] is the j+1-th derivative of time n-i.</span>
<span class="sd">      dt: Time step size.</span>

<span class="sd">    Returns:</span>
<span class="sd">      State values and derivatives for the stages or for the next time step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes an error estimate for the integrator. Similar to _update. Check e.g. Kvaerno.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1">## specific integrator classes</span>

<div class="viewcode-block" id="BackwardEuler"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.BackwardEuler.html#autopdex.dae.BackwardEuler">[docs]</a><span class="k">class</span> <span class="nc">BackwardEuler</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Backward Euler method.</span>
<span class="sd">  </span>
<span class="sd">  Accuracy: 1st order.</span>
<span class="sd">  Stability: L-stable.</span>
<span class="sd">  Number of steps: 1.</span>
<span class="sd">  Number of stages: 1, implicit.</span>
<span class="sd">  Number of derivatives: 1.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BackwardEuler.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.BackwardEuler.html#autopdex.dae.BackwardEuler.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;backward_euler&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,),</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]),</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">1</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="ForwardEuler"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ForwardEuler.html#autopdex.dae.ForwardEuler">[docs]</a><span class="k">class</span> <span class="nc">ForwardEuler</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Forward Euler method.</span>
<span class="sd">  </span>
<span class="sd">  Accuracy: 1st order.</span>
<span class="sd">  Stability: instable for stiff problems.</span>
<span class="sd">  Number of steps: 1.</span>
<span class="sd">  Number of stages: 1, explicit.</span>
<span class="sd">  Number of derivatives: 1.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ForwardEuler.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ForwardEuler.html#autopdex.dae.ForwardEuler.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;forward_euler&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,),</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">1</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="Newmark"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.Newmark.html#autopdex.dae.Newmark">[docs]</a><span class="k">class</span> <span class="nc">Newmark</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Newmark-beta method.</span>
<span class="sd">  </span>
<span class="sd">  Args: </span>
<span class="sd">    gamma (float): Newmark parameter.</span>
<span class="sd">    beta (float): Newmark parameter.</span>

<span class="sd">  Explicit central differences:</span>
<span class="sd">    gamma = 0.5</span>
<span class="sd">    beta = 0</span>
<span class="sd">  </span>
<span class="sd">  Average constant acceleration (middle point rule, unconditional stable):</span>
<span class="sd">    gamma = 0.5</span>
<span class="sd">    beta = 0.25</span>

<span class="sd">  Number of steps: 1.</span>
<span class="sd">  Number of stages: 1, explicit or implicit.</span>
<span class="sd">  Number of derivatives: 2.      </span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Newmark.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.Newmark.html#autopdex.dae.Newmark.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;newmark&quot;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                       <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,),</span>
                       <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span>
                       <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">num_derivs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;newmark&quot;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                       <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,),</span>
                       <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]),</span>
                       <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">num_derivs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span>
      <span class="c1"># Central differences</span>
      <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>
      <span class="n">q_tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q_t_n</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">q_t</span><span class="p">,</span> <span class="n">q_tt</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">v_n</span> <span class="o">=</span> <span class="n">q_t_n</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">a_n</span> <span class="o">=</span> <span class="n">q_t_n</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">q_tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">dq</span> <span class="o">/</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_n</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">a_n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">beta</span><span class="p">))</span> <span class="o">/</span> <span class="n">beta</span>
      <span class="n">q_t</span> <span class="o">=</span> <span class="n">v_n</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_n</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">q_tt</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span><span class="p">,</span> <span class="n">q_tt</span></div>

<div class="viewcode-block" id="AdamsMoulton"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.AdamsMoulton.html#autopdex.dae.AdamsMoulton">[docs]</a><span class="k">class</span> <span class="nc">AdamsMoulton</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Adams-Moulton method.</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_steps (int): Number of previous steps (1 to 6). </span>

<span class="sd">  Number of stages: 1, implicit.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdamsMoulton.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.AdamsMoulton.html#autopdex.dae.AdamsMoulton.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;adams_moulton&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,),</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]),</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">num_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span>

    <span class="c1"># Adams-Moulton coefficients</span>
    <span class="n">adams_moulton_coeffs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="mi">2</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">]),</span>
        <span class="mi">3</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">19</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">]),</span>
        <span class="mi">4</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">251</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">646</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="o">-</span><span class="mi">264</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">106</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="o">-</span><span class="mi">19</span> <span class="o">/</span> <span class="mi">720</span><span class="p">]),</span>
        <span class="mi">5</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">475</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="o">-</span><span class="mi">798</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">482</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="o">-</span><span class="mi">173</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">27</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">]),</span>
        <span class="mi">6</span><span class="p">:</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="mi">19087</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="mi">65112</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="o">-</span><span class="mi">46461</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="mi">37504</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="o">-</span><span class="mi">20211</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="mi">6312</span> <span class="o">/</span> <span class="mi">60480</span><span class="p">,</span> <span class="o">-</span><span class="mi">863</span> <span class="o">/</span> <span class="mi">60480</span>
            <span class="p">]),</span>
    <span class="p">}</span>

    <span class="c1"># Ensure num_steps is supported</span>
    <span class="k">if</span> <span class="n">num_steps</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adams_moulton_coeffs</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_steps=</span><span class="si">{</span><span class="n">num_steps</span><span class="si">}</span><span class="s2"> is not supported. Supported: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">adams_moulton_coeffs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get the coefficients for the specified num_steps</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">adams_moulton_coeffs</span><span class="p">[</span><span class="n">num_steps</span><span class="p">]</span>
    <span class="n">a_0</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute q_t (implicit derivative) using the Adams-Moulton formula</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>  <span class="c1"># Start with the difference quotient</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="n">q_t</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">q_t_n</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># Subtract weighted previous derivatives</span>
    <span class="n">q_t</span> <span class="o">/=</span> <span class="n">a_0</span>  <span class="c1"># Divide by a_0 to solve for q_t</span>

    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="AdamsBashforth"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.AdamsBashforth.html#autopdex.dae.AdamsBashforth">[docs]</a><span class="k">class</span> <span class="nc">AdamsBashforth</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Adams-Bashforth time integrator.</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_steps (int): Number of previous steps (1 to 6).</span>

<span class="sd">  Number of stages: 1, explicit.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdamsBashforth.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.AdamsBashforth.html#autopdex.dae.AdamsBashforth.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;adams_bashforth&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,),</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">num_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">num_steps</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span>
    <span class="c1"># Adams-Bashforth coefficients for different step numbers</span>
    <span class="n">adams_bashforth_coeffs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">23</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">12</span><span class="p">]),</span>
        <span class="mi">3</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">55</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">59</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">37</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span> <span class="o">/</span> <span class="mi">24</span><span class="p">]),</span>
        <span class="mi">4</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1901</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="o">-</span><span class="mi">2774</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">2616</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="o">-</span><span class="mi">1274</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">251</span> <span class="o">/</span> <span class="mi">720</span><span class="p">]),</span>
        <span class="mi">5</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4277</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="o">-</span><span class="mi">7923</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">9982</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="o">-</span><span class="mi">7298</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">2877</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="o">-</span><span class="mi">475</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="c1"># Ensure num_steps is supported</span>
    <span class="k">if</span> <span class="n">num_steps</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adams_bashforth_coeffs</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_steps=</span><span class="si">{</span><span class="n">num_steps</span><span class="si">}</span><span class="s2"> is not supported. Supported number of steps: 1 to 6.&quot;</span><span class="p">)</span>

    <span class="c1"># Get the coefficients for the specified num_steps</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">adams_bashforth_coeffs</span><span class="p">[</span><span class="n">num_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">a_0</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute q_t for the previous step using the Adams-Bashforth formula</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>  <span class="c1"># Start with the difference quotient</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="n">q_t</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">q_t_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># Subtract weighted previous derivatives</span>
    <span class="n">q_t</span> <span class="o">/=</span> <span class="n">a_0</span>  <span class="c1"># Divide by a_0</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="BackwardDiffFormula"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.BackwardDiffFormula.html#autopdex.dae.BackwardDiffFormula">[docs]</a><span class="k">class</span> <span class="nc">BackwardDiffFormula</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Backward differentiation formula (BDF).</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_steps (int): Number of previous steps (1 to 6).</span>
<span class="sd">    </span>
<span class="sd">  Number of stages: 1, implicit.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BackwardDiffFormula.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.BackwardDiffFormula.html#autopdex.dae.BackwardDiffFormula.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;backward_diff_formula&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">0</span><span class="p">]]),</span> <span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,),</span>
                     <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]),</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">num_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">num_steps</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_n1</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span>
    <span class="c1"># BDF coefficients for different orders</span>
    <span class="n">bdf_coeffs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="mi">3</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">]),</span>
        <span class="mi">4</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">25</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]),</span>
        <span class="mi">5</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">137</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">]),</span>
        <span class="mi">6</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">49</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">15</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="c1"># Ensure num_steps is supported</span>
    <span class="k">if</span> <span class="n">num_steps</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bdf_coeffs</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s2">&quot;Order of BDF method not supported. Supported orders: 1 to 6. From 7 on the BDF method is not stable.&quot;</span><span class="p">)</span>

    <span class="c1"># Get the coefficients for the specified order</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">bdf_coeffs</span><span class="p">[</span><span class="n">num_steps</span><span class="p">]</span>

    <span class="c1"># Backward differentiation formula</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">q_n</span><span class="p">))</span> <span class="o">/</span> <span class="n">dt</span>

    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="ExplicitRungeKutta"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ExplicitRungeKutta.html#autopdex.dae.ExplicitRungeKutta">[docs]</a><span class="k">class</span> <span class="nc">ExplicitRungeKutta</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Explicit Runge-Kutta method.</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_stages (int): Number of stages (1, 2, 3, 4, 5, 6, 7, 9, 11).</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExplicitRungeKutta.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ExplicitRungeKutta.html#autopdex.dae.ExplicitRungeKutta.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_stages</span><span class="p">):</span>
    <span class="k">match</span> <span class="n">num_stages</span><span class="p">:</span>  <span class="c1"># From JC Butcher 2008: Numerical Methods for Ordinary Differential Equations, ISBN: 978-0-470-72335-7</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Forward Euler</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Heun&#39;s method</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Kutta&#39;s third-order method</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Classic Runge-Kutta method</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
      <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">7</span> <span class="o">/</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">90</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">13</span> <span class="o">/</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">13</span> <span class="o">/</span> <span class="mi">200</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">25</span> <span class="o">/</span> <span class="mi">48</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">35</span> <span class="o">/</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">15</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">261</span> <span class="o">/</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">33</span> <span class="o">/</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">43</span> <span class="o">/</span> <span class="mi">156</span><span class="p">,</span> <span class="o">-</span><span class="mi">118</span> <span class="o">/</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">80</span> <span class="o">/</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">6</span>
      <span class="k">case</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1771561</span> <span class="o">/</span> <span class="mi">6289920</span><span class="p">,</span> <span class="mi">243</span> <span class="o">/</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">16807</span> <span class="o">/</span> <span class="mi">74880</span><span class="p">,</span> <span class="mi">77</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">270</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">148</span> <span class="o">/</span> <span class="mi">1331</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span> <span class="o">/</span> <span class="mi">1331</span><span class="p">,</span> <span class="o">-</span><span class="mi">56</span> <span class="o">/</span> <span class="mi">1331</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">404</span> <span class="o">/</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">170</span> <span class="o">/</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">4024</span> <span class="o">/</span> <span class="mi">1701</span><span class="p">,</span> <span class="mi">10648</span> <span class="o">/</span> <span class="mi">1701</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">2466</span> <span class="o">/</span> <span class="mi">2401</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1242</span> <span class="o">/</span> <span class="mi">343</span><span class="p">,</span> <span class="o">-</span><span class="mi">19176</span> <span class="o">/</span> <span class="mi">16807</span><span class="p">,</span> <span class="o">-</span><span class="mi">51909</span> <span class="o">/</span> <span class="mi">16807</span><span class="p">,</span> <span class="mi">1053</span> <span class="o">/</span> <span class="mi">2401</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span> <span class="o">/</span> <span class="mi">539</span><span class="p">,</span> <span class="o">-</span><span class="mi">1815</span> <span class="o">/</span> <span class="mi">20384</span><span class="p">,</span> <span class="o">-</span><span class="mi">405</span> <span class="o">/</span> <span class="mi">2464</span><span class="p">,</span> <span class="mi">49</span> <span class="o">/</span> <span class="mi">1144</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="o">-</span><span class="mi">113</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">195</span> <span class="o">/</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">29403</span> <span class="o">/</span> <span class="mi">3584</span><span class="p">,</span> <span class="o">-</span><span class="mi">729</span> <span class="o">/</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1029</span> <span class="o">/</span> <span class="mi">1408</span><span class="p">,</span> <span class="mi">21</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">7</span>
      <span class="k">case</span> <span class="mi">11</span><span class="p">:</span>
        <span class="n">sqrt_21</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">49</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">49</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">98</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[(</span><span class="mi">11</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">63</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">-</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">231</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span><span class="p">,</span>
                                <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">432</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">315</span><span class="p">,</span> <span class="p">(</span><span class="mi">633</span> <span class="o">-</span> <span class="mi">145</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">90</span><span class="p">,</span>
                                <span class="p">(</span><span class="o">-</span><span class="mi">504</span> <span class="o">+</span> <span class="mi">115</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">70</span><span class="p">,</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">13</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">126</span><span class="p">,</span> <span class="p">(</span><span class="mi">13</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">1</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">91</span> <span class="o">-</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">72</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">385</span> <span class="o">-</span> <span class="mi">75</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1152</span><span class="p">,</span>
                                   <span class="p">(</span><span class="mi">63</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">1</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">733</span> <span class="o">-</span> <span class="mi">147</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2205</span><span class="p">,</span> <span class="p">(</span><span class="mi">515</span> <span class="o">+</span> <span class="mi">111</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">504</span><span class="p">,</span>
                                   <span class="p">(</span><span class="o">-</span><span class="mi">51</span> <span class="o">-</span> <span class="mi">11</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">56</span><span class="p">,</span> <span class="p">(</span><span class="mi">132</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">42</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span>
                                   <span class="p">(</span><span class="o">-</span><span class="mi">273</span> <span class="o">-</span> <span class="mi">53</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">72</span><span class="p">,</span> <span class="p">(</span><span class="mi">301</span> <span class="o">+</span> <span class="mi">53</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">72</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span> <span class="o">-</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span>
                                   <span class="p">(</span><span class="mi">49</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">sqrt_21</span><span class="p">)</span> <span class="o">/</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_stages not supported for ExplicitRungeKutta. Supported: 1, 2, 3, 4, 6, 7, 9, 11&quot;</span><span class="p">)</span>

    <span class="n">stages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">)])</span>
    <span class="n">stage_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">))</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;explicit_runge_kutta&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">stages</span><span class="p">,</span>
                     <span class="n">stage_types</span><span class="p">,</span>
                     <span class="n">butcher_c</span><span class="p">,</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">invert_butcher_with_order</span><span class="p">(</span><span class="n">butcher_A</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span> <span class="o">=</span> <span class="n">butcher_A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">butcher_b</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_c</span> <span class="o">=</span> <span class="n">butcher_c</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span><span class="p">,</span> <span class="n">q_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="DiagonallyImplicitRungeKutta"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.DiagonallyImplicitRungeKutta.html#autopdex.dae.DiagonallyImplicitRungeKutta">[docs]</a><span class="k">class</span> <span class="nc">DiagonallyImplicitRungeKutta</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Diagonally implicit Runge-Kutta method.</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_stages (int): Number of stages (1, 2, 3).</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DiagonallyImplicitRungeKutta.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.DiagonallyImplicitRungeKutta.html#autopdex.dae.DiagonallyImplicitRungeKutta.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_stages</span><span class="p">):</span>
    <span class="k">match</span> <span class="n">num_stages</span><span class="p">:</span>  <span class="c1"># From JC Butcher 2008: Numerical Methods for Ordinary Differential Equations, ISBN: 978-0-470-72335-7</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Implicit midpoint (GauÃŸ-Legendre, 2nd order, symplectic)</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Crouzeix&#39;s method (3rd order)</span>
        <span class="n">sqrt_3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">one_half</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">one_half</span> <span class="o">+</span> <span class="n">sqrt_3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">one_half</span> <span class="o">-</span> <span class="n">sqrt_3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">one_half</span><span class="p">,</span> <span class="n">one_half</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">one_half</span> <span class="o">+</span> <span class="n">sqrt_3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">sqrt_3</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">one_half</span> <span class="o">+</span> <span class="n">sqrt_3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Crouzeix&#39;s method (4rd order)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">18</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
      <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_stages not supported for ExplicitRungeKutta. Supported: 1, 2, 3&quot;</span><span class="p">)</span>

    <span class="n">stages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">)])</span>
    <span class="n">stage_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">))</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;diagonally_implicit_runge_kutta&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">stages</span><span class="p">,</span>
                     <span class="n">stage_types</span><span class="p">,</span>
                     <span class="n">butcher_c</span><span class="p">,</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">invert_butcher_with_order</span><span class="p">(</span><span class="n">butcher_A</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span> <span class="o">=</span> <span class="n">butcher_A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">butcher_b</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_c</span> <span class="o">=</span> <span class="n">butcher_c</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># q contains all stages (first dimension)</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span><span class="p">,</span> <span class="n">q_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="Kvaerno"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.Kvaerno.html#autopdex.dae.Kvaerno">[docs]</a><span class="k">class</span> <span class="nc">Kvaerno</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Kvaerno method (explicit first stage diagonally implicit Runge-Kutta with embedded error estimation).</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    order (int): Order of the method (3, 4, 5).</span>
<span class="sd">    </span>
<span class="sd">  Supports PID control.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Kvaerno.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.Kvaerno.html#autopdex.dae.Kvaerno.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="k">match</span> <span class="n">order</span><span class="p">:</span>  <span class="c1"># Coefficients from https://github.com/patrick-kidger/diffrax/blob/0a59c9dbd34f580efb3505386f38ce9fcedb120b/diffrax/_solver -&gt; kvaerno{3,4,5}.py</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">Î³</span> <span class="o">=</span> <span class="mf">0.43586652150</span>
        <span class="n">a21</span> <span class="o">=</span> <span class="n">Î³</span>
        <span class="n">a31</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Î³</span><span class="p">)</span>
        <span class="n">a32</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Î³</span><span class="p">)</span>
        <span class="n">a41</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">Î³</span><span class="p">)</span>
        <span class="n">a42</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="mi">24</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="n">Î³</span><span class="p">)</span>
        <span class="n">a43</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Î³</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a41</span><span class="p">,</span> <span class="n">a42</span><span class="p">,</span> <span class="n">a43</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">error_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a41</span> <span class="o">-</span> <span class="n">a31</span><span class="p">,</span> <span class="n">a42</span> <span class="o">-</span> <span class="n">a32</span><span class="p">,</span> <span class="n">a43</span> <span class="o">-</span> <span class="n">Î³</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a21</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a31</span><span class="p">,</span> <span class="n">a32</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a41</span><span class="p">,</span> <span class="n">a42</span><span class="p">,</span> <span class="n">a43</span><span class="p">,</span> <span class="n">Î³</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">Î³</span> <span class="o">=</span> <span class="mf">0.5728160625</span>

        <span class="k">def</span> <span class="nf">poly</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">Î³</span><span class="p">)</span>

        <span class="n">a21</span> <span class="o">=</span> <span class="n">Î³</span>
        <span class="n">a31</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">/</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">a32</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Î³</span> <span class="o">/</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">a41</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="o">-</span><span class="mi">144</span><span class="p">,</span> <span class="mi">396</span><span class="p">,</span> <span class="o">-</span><span class="mi">330</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">a42</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="o">-</span><span class="mi">126</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a43</span> <span class="o">=</span> <span class="p">(</span><span class="n">poly</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a51</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="o">-</span><span class="mi">312</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">a52</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a53</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">Î³</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">poly</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a54</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">poly</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">Î³</span> <span class="o">+</span> <span class="n">a21</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">Î³</span> <span class="o">+</span> <span class="n">a31</span> <span class="o">+</span> <span class="n">a32</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">c5</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a51</span><span class="p">,</span> <span class="n">a52</span><span class="p">,</span> <span class="n">a53</span><span class="p">,</span> <span class="n">a54</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">error_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a51</span> <span class="o">-</span> <span class="n">a41</span><span class="p">,</span> <span class="n">a52</span> <span class="o">-</span> <span class="n">a42</span><span class="p">,</span> <span class="n">a53</span> <span class="o">-</span> <span class="n">a43</span><span class="p">,</span> <span class="n">a54</span> <span class="o">-</span> <span class="n">Î³</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a21</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a31</span><span class="p">,</span> <span class="n">a32</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a41</span><span class="p">,</span> <span class="n">a42</span><span class="p">,</span> <span class="n">a43</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">a51</span><span class="p">,</span> <span class="n">a52</span><span class="p">,</span> <span class="n">a53</span><span class="p">,</span> <span class="n">a54</span><span class="p">,</span> <span class="n">Î³</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
      <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">Î³</span> <span class="o">=</span> <span class="mf">0.26</span>
        <span class="n">a21</span> <span class="o">=</span> <span class="n">Î³</span>
        <span class="n">a31</span> <span class="o">=</span> <span class="mf">0.13</span>
        <span class="n">a32</span> <span class="o">=</span> <span class="mf">0.84033320996790809</span>
        <span class="n">a41</span> <span class="o">=</span> <span class="mf">0.22371961478320505</span>
        <span class="n">a42</span> <span class="o">=</span> <span class="mf">0.47675532319799699</span>
        <span class="n">a43</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.06470895363112615</span>
        <span class="n">a51</span> <span class="o">=</span> <span class="mf">0.16648564323248321</span>
        <span class="n">a52</span> <span class="o">=</span> <span class="mf">0.10450018841591720</span>
        <span class="n">a53</span> <span class="o">=</span> <span class="mf">0.03631482272098715</span>
        <span class="n">a54</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.13090704451073998</span>
        <span class="n">a61</span> <span class="o">=</span> <span class="mf">0.13855640231268224</span>
        <span class="n">a62</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a63</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.04245337201752043</span>
        <span class="n">a64</span> <span class="o">=</span> <span class="mf">0.02446657898003141</span>
        <span class="n">a65</span> <span class="o">=</span> <span class="mf">0.61943039072480676</span>
        <span class="n">a71</span> <span class="o">=</span> <span class="mf">0.13659751177640291</span>
        <span class="n">a72</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a73</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05496908796538376</span>
        <span class="n">a74</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.04118626728321046</span>
        <span class="n">a75</span> <span class="o">=</span> <span class="mf">0.62993304899016403</span>
        <span class="n">a76</span> <span class="o">=</span> <span class="mf">0.06962479448202728</span>

        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.52</span><span class="p">,</span> <span class="mf">1.230333209967908</span><span class="p">,</span> <span class="mf">0.8957659843500759</span><span class="p">,</span> <span class="mf">0.43639360985864756</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a71</span><span class="p">,</span> <span class="n">a72</span><span class="p">,</span> <span class="n">a73</span><span class="p">,</span> <span class="n">a74</span><span class="p">,</span> <span class="n">a75</span><span class="p">,</span> <span class="n">a76</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">error_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a71</span> <span class="o">-</span> <span class="n">a61</span><span class="p">,</span> <span class="n">a72</span> <span class="o">-</span> <span class="n">a62</span><span class="p">,</span> <span class="n">a73</span> <span class="o">-</span> <span class="n">a63</span><span class="p">,</span> <span class="n">a74</span> <span class="o">-</span> <span class="n">a64</span><span class="p">,</span> <span class="n">a75</span> <span class="o">-</span> <span class="n">a65</span><span class="p">,</span> <span class="n">a76</span> <span class="o">-</span> <span class="n">Î³</span><span class="p">,</span> <span class="n">Î³</span><span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a21</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a31</span><span class="p">,</span> <span class="n">a32</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">a41</span><span class="p">,</span> <span class="n">a42</span><span class="p">,</span> <span class="n">a43</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a51</span><span class="p">,</span> <span class="n">a52</span><span class="p">,</span> <span class="n">a53</span><span class="p">,</span> <span class="n">a54</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">a61</span><span class="p">,</span> <span class="n">a62</span><span class="p">,</span> <span class="n">a63</span><span class="p">,</span> <span class="n">a64</span><span class="p">,</span> <span class="n">a65</span><span class="p">,</span> <span class="n">Î³</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">a71</span><span class="p">,</span> <span class="n">a72</span><span class="p">,</span> <span class="n">a73</span><span class="p">,</span> <span class="n">a74</span><span class="p">,</span> <span class="n">a75</span><span class="p">,</span> <span class="n">a76</span><span class="p">,</span> <span class="n">Î³</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;order not supported for Kvaerno. Supported: 3, 4, 5&quot;</span><span class="p">)</span>

    <span class="n">num_stages</span> <span class="o">=</span> <span class="n">butcher_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">)])</span>
    <span class="n">stage_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Kvaerno&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">stages</span><span class="p">,</span>
                     <span class="n">stage_types</span><span class="p">,</span>
                     <span class="n">butcher_c</span><span class="p">,</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">invert_butcher_with_order</span><span class="p">(</span><span class="n">butcher_A</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span> <span class="o">=</span> <span class="n">butcher_A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">butcher_b</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_c</span> <span class="o">=</span> <span class="n">butcher_c</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error_b</span> <span class="o">=</span> <span class="n">error_b</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_b</span>
    <span class="n">error_estimate</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_estimate</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># q contains all stages (first dimension)</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span><span class="p">,</span> <span class="n">q_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="DormandPrince"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.DormandPrince.html#autopdex.dae.DormandPrince">[docs]</a><span class="k">class</span> <span class="nc">DormandPrince</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Dormand-Prince method (explicit with embedded error estimation).</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    order (int): Order of the method (5, 8).</span>
<span class="sd">    </span>
<span class="sd">  Supports PID control.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DormandPrince.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.DormandPrince.html#autopdex.dae.DormandPrince.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="c1"># Coefficients from https://github.com/patrick-kidger/diffrax/blob/0a59c9dbd34f580efb3505386f38ce9fcedb120b/diffrax/_solver -&gt; dopri{5,8}.py</span>
    <span class="k">match</span> <span class="n">order</span><span class="p">:</span>
      <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">35</span> <span class="o">/</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span> <span class="o">/</span> <span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span> <span class="o">/</span> <span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span> <span class="o">/</span> <span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">error_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">35</span> <span class="o">/</span> <span class="mi">384</span> <span class="o">-</span> <span class="mi">1951</span> <span class="o">/</span> <span class="mi">21600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span> <span class="o">/</span> <span class="mi">1113</span> <span class="o">-</span> <span class="mi">22642</span> <span class="o">/</span> <span class="mi">50085</span><span class="p">,</span> <span class="mi">125</span> <span class="o">/</span> <span class="mi">192</span> <span class="o">-</span> <span class="mi">451</span> <span class="o">/</span> <span class="mi">720</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">2187</span> <span class="o">/</span> <span class="mi">6784</span> <span class="o">-</span> <span class="o">-</span><span class="mi">12231</span> <span class="o">/</span> <span class="mi">42400</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">84</span> <span class="o">-</span> <span class="mi">649</span> <span class="o">/</span> <span class="mi">6300</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">60.0</span>
        <span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">44</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">56</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">19372</span> <span class="o">/</span> <span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">25360</span> <span class="o">/</span> <span class="mi">2187</span><span class="p">,</span> <span class="mi">64448</span> <span class="o">/</span> <span class="mi">6561</span><span class="p">,</span> <span class="o">-</span><span class="mi">212</span> <span class="o">/</span> <span class="mi">729</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">9017</span> <span class="o">/</span> <span class="mi">3168</span><span class="p">,</span> <span class="o">-</span><span class="mi">355</span> <span class="o">/</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">46732</span> <span class="o">/</span> <span class="mi">5247</span><span class="p">,</span> <span class="mi">49</span> <span class="o">/</span> <span class="mi">176</span><span class="p">,</span> <span class="o">-</span><span class="mi">5103</span> <span class="o">/</span> <span class="mi">18656</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">35</span> <span class="o">/</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span> <span class="o">/</span> <span class="mi">1113</span><span class="p">,</span> <span class="mi">125</span> <span class="o">/</span> <span class="mi">192</span><span class="p">,</span> <span class="o">-</span><span class="mi">2187</span> <span class="o">/</span> <span class="mi">6784</span><span class="p">,</span> <span class="mi">11</span> <span class="o">/</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">59</span> <span class="o">/</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">93</span> <span class="o">/</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">5490023248</span> <span class="o">/</span> <span class="mi">9719169821</span><span class="p">,</span> <span class="mi">13</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
            <span class="mi">1201146811</span> <span class="o">/</span> <span class="mi">1299019798</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">])</span>
        <span class="n">butcher_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">14005451</span> <span class="o">/</span> <span class="mi">335480064</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">59238493</span> <span class="o">/</span> <span class="mi">1068277825</span><span class="p">,</span> <span class="mi">181606767</span> <span class="o">/</span> <span class="mi">758867731</span><span class="p">,</span> <span class="mi">561292985</span> <span class="o">/</span> <span class="mi">797845732</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1041891430</span> <span class="o">/</span> <span class="mi">1371343529</span><span class="p">,</span> <span class="mi">760417239</span> <span class="o">/</span> <span class="mi">1151165299</span><span class="p">,</span> <span class="mi">118820643</span> <span class="o">/</span> <span class="mi">751138087</span><span class="p">,</span> <span class="o">-</span><span class="mi">528747749</span> <span class="o">/</span> <span class="mi">2220607170</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">])</span>
        <span class="n">error_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">14005451</span> <span class="o">/</span> <span class="mi">335480064</span> <span class="o">-</span> <span class="mi">13451932</span> <span class="o">/</span> <span class="mi">455176623</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">59238493</span> <span class="o">/</span> <span class="mi">1068277825</span> <span class="o">-</span> <span class="o">-</span><span class="mi">808719846</span> <span class="o">/</span> <span class="mi">976000145</span><span class="p">,</span>
            <span class="mi">181606767</span> <span class="o">/</span> <span class="mi">758867731</span> <span class="o">-</span> <span class="mi">1757004468</span> <span class="o">/</span> <span class="mi">5645159321</span><span class="p">,</span> <span class="mi">561292985</span> <span class="o">/</span> <span class="mi">797845732</span> <span class="o">-</span> <span class="mi">656045339</span> <span class="o">/</span> <span class="mi">265891186</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1041891430</span> <span class="o">/</span> <span class="mi">1371343529</span> <span class="o">-</span> <span class="o">-</span><span class="mi">3867574721</span> <span class="o">/</span> <span class="mi">1518517206</span><span class="p">,</span> <span class="mi">760417239</span> <span class="o">/</span> <span class="mi">1151165299</span> <span class="o">-</span> <span class="mi">465885868</span> <span class="o">/</span> <span class="mi">322736535</span><span class="p">,</span>
            <span class="mi">118820643</span> <span class="o">/</span> <span class="mi">751138087</span> <span class="o">-</span> <span class="mi">53011238</span> <span class="o">/</span> <span class="mi">667516719</span><span class="p">,</span> <span class="o">-</span><span class="mi">528747749</span> <span class="o">/</span> <span class="mi">2220607170</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">])</span>
        <span class="n">butcher_A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span> <span class="o">/</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">75</span> <span class="o">/</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">29443841</span> <span class="o">/</span> <span class="mi">614563906</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">77736538</span> <span class="o">/</span> <span class="mi">692538347</span><span class="p">,</span> <span class="o">-</span><span class="mi">28693883</span> <span class="o">/</span> <span class="mi">1125000000</span><span class="p">,</span>
                                   <span class="mi">23124283</span> <span class="o">/</span> <span class="mi">1800000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">16016141</span> <span class="o">/</span> <span class="mi">946692911</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">61564180</span> <span class="o">/</span> <span class="mi">158732637</span><span class="p">,</span> <span class="mi">22789713</span> <span class="o">/</span> <span class="mi">633445777</span><span class="p">,</span>
                                   <span class="mi">545815736</span> <span class="o">/</span> <span class="mi">2771057229</span><span class="p">,</span> <span class="o">-</span><span class="mi">180193667</span> <span class="o">/</span> <span class="mi">1043307555</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">39632708</span> <span class="o">/</span> <span class="mi">573591083</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">433636366</span> <span class="o">/</span> <span class="mi">683701615</span><span class="p">,</span> <span class="o">-</span><span class="mi">421739975</span> <span class="o">/</span> <span class="mi">2616292301</span><span class="p">,</span>
                                   <span class="mi">100302831</span> <span class="o">/</span> <span class="mi">723423059</span><span class="p">,</span> <span class="mi">790204164</span> <span class="o">/</span> <span class="mi">839813087</span><span class="p">,</span> <span class="mi">800635310</span> <span class="o">/</span> <span class="mi">3783071287</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">246121993</span> <span class="o">/</span> <span class="mi">1340847787</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">37695042795</span> <span class="o">/</span> <span class="mi">15268766246</span><span class="p">,</span> <span class="o">-</span><span class="mi">309121744</span> <span class="o">/</span> <span class="mi">1061227803</span><span class="p">,</span>
                                   <span class="o">-</span><span class="mi">12992083</span> <span class="o">/</span> <span class="mi">490766935</span><span class="p">,</span> <span class="mi">6005943493</span> <span class="o">/</span> <span class="mi">2108947869</span><span class="p">,</span> <span class="mi">393006217</span> <span class="o">/</span> <span class="mi">1396673457</span><span class="p">,</span>
                                   <span class="mi">123872331</span> <span class="o">/</span> <span class="mi">1001029789</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="o">-</span><span class="mi">1028468189</span> <span class="o">/</span> <span class="mi">846180014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8478235783</span> <span class="o">/</span> <span class="mi">508512852</span><span class="p">,</span> <span class="mi">1311729495</span> <span class="o">/</span> <span class="mi">1432422823</span><span class="p">,</span>
                                   <span class="o">-</span><span class="mi">10304129995</span> <span class="o">/</span> <span class="mi">1701304382</span><span class="p">,</span> <span class="o">-</span><span class="mi">48777925059</span> <span class="o">/</span> <span class="mi">3047939560</span><span class="p">,</span> <span class="mi">15336726248</span> <span class="o">/</span> <span class="mi">1032824649</span><span class="p">,</span>
                                   <span class="o">-</span><span class="mi">45442868181</span> <span class="o">/</span> <span class="mi">3398467696</span><span class="p">,</span> <span class="mi">3065993473</span> <span class="o">/</span> <span class="mi">597172653</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">185892177</span> <span class="o">/</span> <span class="mi">718116043</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3185094517</span> <span class="o">/</span> <span class="mi">667107341</span><span class="p">,</span> <span class="o">-</span><span class="mi">477755414</span> <span class="o">/</span> <span class="mi">1098053517</span><span class="p">,</span>
                                   <span class="o">-</span><span class="mi">703635378</span> <span class="o">/</span> <span class="mi">230739211</span><span class="p">,</span> <span class="mi">5731566787</span> <span class="o">/</span> <span class="mi">1027545527</span><span class="p">,</span> <span class="mi">5232866602</span> <span class="o">/</span> <span class="mi">850066563</span><span class="p">,</span>
                                   <span class="o">-</span><span class="mi">4093664535</span> <span class="o">/</span> <span class="mi">808688257</span><span class="p">,</span> <span class="mi">3962137247</span> <span class="o">/</span> <span class="mi">1805957418</span><span class="p">,</span> <span class="mi">65686358</span> <span class="o">/</span> <span class="mi">487910083</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">403863854</span> <span class="o">/</span> <span class="mi">491063109</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5068492393</span> <span class="o">/</span> <span class="mi">434740067</span><span class="p">,</span> <span class="o">-</span><span class="mi">411421997</span> <span class="o">/</span> <span class="mi">543043805</span><span class="p">,</span>
                                   <span class="mi">652783627</span> <span class="o">/</span> <span class="mi">914296604</span><span class="p">,</span> <span class="mi">11173962825</span> <span class="o">/</span> <span class="mi">925320556</span><span class="p">,</span> <span class="o">-</span><span class="mi">13158990841</span> <span class="o">/</span> <span class="mi">6184727034</span><span class="p">,</span>
                                   <span class="mi">3936647629</span> <span class="o">/</span> <span class="mi">1978049680</span><span class="p">,</span> <span class="o">-</span><span class="mi">160528059</span> <span class="o">/</span> <span class="mi">685178525</span><span class="p">,</span> <span class="mi">248638103</span> <span class="o">/</span> <span class="mi">1413531060</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">],</span>
                               <span class="p">[</span>
                                   <span class="mi">14005451</span> <span class="o">/</span> <span class="mi">335480064</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">59238493</span> <span class="o">/</span> <span class="mi">1068277825</span><span class="p">,</span> <span class="mi">181606767</span> <span class="o">/</span> <span class="mi">758867731</span><span class="p">,</span>
                                   <span class="mi">561292985</span> <span class="o">/</span> <span class="mi">797845732</span><span class="p">,</span> <span class="o">-</span><span class="mi">1041891430</span> <span class="o">/</span> <span class="mi">1371343529</span><span class="p">,</span> <span class="mi">760417239</span> <span class="o">/</span> <span class="mi">1151165299</span><span class="p">,</span>
                                   <span class="mi">118820643</span> <span class="o">/</span> <span class="mi">751138087</span><span class="p">,</span> <span class="o">-</span><span class="mi">528747749</span> <span class="o">/</span> <span class="mi">2220607170</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>
                               <span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;order not supported for DormandPrince. Supported: 5, 8&quot;</span><span class="p">)</span>

    <span class="n">num_stages</span> <span class="o">=</span> <span class="n">butcher_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">)])</span>
    <span class="n">stage_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stages</span><span class="p">))</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;DormandPrince&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">stages</span><span class="p">,</span>
                     <span class="n">stage_types</span><span class="p">,</span>
                     <span class="n">butcher_c</span><span class="p">,</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">invert_butcher_with_order</span><span class="p">(</span><span class="n">butcher_A</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span> <span class="o">=</span> <span class="n">butcher_A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">butcher_b</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_c</span> <span class="o">=</span> <span class="n">butcher_c</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error_b</span> <span class="o">=</span> <span class="n">error_b</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_b</span>
    <span class="n">error_estimate</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_estimate</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># q contains all stages (first dimension)</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span><span class="p">,</span> <span class="n">q_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>

<div class="viewcode-block" id="GaussLegendreRungeKutta"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.GaussLegendreRungeKutta.html#autopdex.dae.GaussLegendreRungeKutta">[docs]</a><span class="k">class</span> <span class="nc">GaussLegendreRungeKutta</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Gauss-Legendre Runge-Kutta method (fully implicit).</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    num_stages (int): Number of stages.</span>

<span class="sd">  Accuracy: 2 * num_stages.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GaussLegendreRungeKutta.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.GaussLegendreRungeKutta.html#autopdex.dae.GaussLegendreRungeKutta.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_stages</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_gauss_legendre_coefficients</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
      <span class="c1"># from numpy.polynomial.legendre import leggauss</span>

      <span class="c1"># 1. Berechne die GauÃŸ-Legendre-Knoten und -Gewichte auf [-1, 1]</span>
      <span class="n">nodes</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">leggauss</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

      <span class="c1"># 2. Skaliere die Knoten und Gewichte auf [0, 1]</span>
      <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nodes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">weights</span>

      <span class="c1"># 3. Berechne die Matrix A</span>
      <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
          <span class="c1"># Erstelle die Lagrange-Basisfunktion L_j(x)</span>
          <span class="n">L_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
              <span class="n">L_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">L_j</span><span class="o">.</span><span class="n">coeffs</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
          <span class="c1"># Integriere L_j(x) von 0 bis c_i</span>
          <span class="n">Lj_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyint</span><span class="p">(</span><span class="n">L_j</span><span class="p">)</span>
          <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lj_int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Lj_int</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

      <span class="c1"># 4. Konvertiere A, c und b zu JAX-Arrays</span>
      <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>

    <span class="n">butcher_A</span><span class="p">,</span> <span class="n">butcher_b</span><span class="p">,</span> <span class="n">butcher_c</span> <span class="o">=</span> <span class="n">get_gauss_legendre_coefficients</span><span class="p">(</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="n">butcher_A_inv</span><span class="p">,</span> <span class="n">stage_order</span> <span class="o">=</span> <span class="n">invert_butcher_with_order</span><span class="p">(</span><span class="n">butcher_A</span><span class="p">)</span>

    <span class="n">stage_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stage_order</span><span class="p">)</span>
    <span class="n">stage_order</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stage_order</span><span class="p">])</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;GaussLegendreRungeKutta&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span>
                     <span class="n">stage_order</span><span class="p">,</span>
                     <span class="n">stage_types</span><span class="p">,</span>
                     <span class="n">butcher_c</span><span class="p">,</span>
                     <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_derivs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">num_stages</span><span class="o">=</span><span class="n">num_stages</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">=</span> <span class="n">num_stages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">butcher_A_inv</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span> <span class="o">=</span> <span class="n">butcher_A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span> <span class="o">=</span> <span class="n">butcher_b</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">butcher_c</span> <span class="o">=</span> <span class="n">butcher_c</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_stages</span></div>

  <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="c1"># Linear combination of stage results</span>
    <span class="n">q_s_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;j,j...-&gt;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_b</span><span class="p">,</span> <span class="n">q_s_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span>

  <span class="k">def</span> <span class="nf">_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># q contains all stages (first dimension)</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A_inv</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stages</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,j...-&gt;i...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">butcher_A</span><span class="p">,</span> <span class="n">q_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_t</span></div>


<span class="c1">## Saving policies</span>

<div class="viewcode-block" id="HistoryState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.HistoryState.html#autopdex.dae.HistoryState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">HistoryState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Container for storing the history state data.</span>

<span class="sd">  Attributes:</span>
<span class="sd">      t: Dictionary of time data arrays.</span>
<span class="sd">      q: Dictionary of state variable arrays.</span>
<span class="sd">      user: Dictionary of additional user data.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">t</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">q</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">Any</span></div>

<div class="viewcode-block" id="SavePolicy"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SavePolicy.html#autopdex.dae.SavePolicy">[docs]</a><span class="k">class</span> <span class="nc">SavePolicy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Abstract base class for save strategies.&quot;&quot;&quot;</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">        q: Dictionary of state variables.</span>
<span class="sd">        t_max: Maximum simulation time.</span>
<span class="sd">        num_time_steps: Number of time steps.</span>
<span class="sd">        user_data: Dictionary of additional user data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An initial state for the saving strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">save_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the desired data to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current history state.</span>
<span class="sd">        t: The current time.</span>
<span class="sd">        q: The current state dictionary.</span>
<span class="sd">        user_data: Dictionary of additional user data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated history state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finalizes the storage and returns the relevant history data.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current history state.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The finalized history data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SaveNothingPolicy"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveNothingPolicy.html#autopdex.dae.SaveNothingPolicy">[docs]</a><span class="k">class</span> <span class="nc">SaveNothingPolicy</span><span class="p">(</span><span class="n">SavePolicy</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A policy that does not save any data.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">save_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SaveEquidistantHistoryState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveEquidistantHistoryState.html#autopdex.dae.SaveEquidistantHistoryState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SaveEquidistantHistoryState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the SaveAllPolicy.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span>
  <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">target_times</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
  <span class="n">t</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">q</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">current_save_idx</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">Any</span></div>

<div class="viewcode-block" id="SaveEquidistantPolicy"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveEquidistantPolicy.html#autopdex.dae.SaveEquidistantPolicy">[docs]</a><span class="k">class</span> <span class="nc">SaveEquidistantPolicy</span><span class="p">(</span><span class="n">SavePolicy</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Saves data at (approximately) equidistant time points using pre-allocated arrays.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SaveEquidistantPolicy.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveEquidistantPolicy.html#autopdex.dae.SaveEquidistantPolicy.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span> <span class="o">=</span> <span class="n">num_points</span></div>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialisiert die vorab allokierten Arrays fÃ¼r Zeit und ZustÃ¤nde.</span>

<span class="sd">    Args:</span>
<span class="sd">        q_keys: SchlÃ¼ssel der Zustandsvariablen.</span>
<span class="sd">        q_shapes: Formen der Zustandsvariablen.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Ein Tupel aus:</span>
<span class="sd">            - history_t: Array fÃ¼r die Zeitdaten.</span>
<span class="sd">            - history_q: Dictionary von Arrays fÃ¼r die Zustandsdaten.</span>
<span class="sd">            - target_times: Array der Zielzeitpunkte.</span>
<span class="sd">            - current_save_idx: Initialer Index fÃ¼r das Speichern.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_steps</span>
    <span class="n">history_t</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">history_q</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">history_user</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">user_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">user_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">target_times</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">num_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">current_save_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">SaveEquidistantHistoryState</span><span class="p">(</span><span class="n">t_max</span><span class="p">,</span>
                                       <span class="n">num_points</span><span class="p">,</span>
                                       <span class="n">target_times</span><span class="p">,</span>
                                       <span class="n">history_t</span><span class="p">,</span>
                                       <span class="n">history_q</span><span class="p">,</span>
                                       <span class="n">current_save_idx</span><span class="p">,</span>
                                       <span class="n">user</span><span class="o">=</span><span class="n">history_user</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Speichert den aktuellen Zustand, wenn der Zielzeitpunkt erreicht ist.</span>

<span class="sd">    Args:</span>
<span class="sd">      state: Ein Tupel aus (history_t, history_q, target_times, current_save_idx).</span>
<span class="sd">      t: Aktuelle Zeit.</span>
<span class="sd">      q: Aktueller Zustand.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Aktualisierter Zustand mit gespeicherten Daten und aktualisiertem Index.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bedingung: Ist die aktuelle Zeit &gt;= Zielzeitpunkt - Toleranz?</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">target_times</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_save</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
      <span class="c1"># Speichere die aktuelle Zeit</span>
      <span class="n">state</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

      <span class="c1"># Speichere die aktuellen ZustÃ¤nde</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">user_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
          <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">user_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

      <span class="c1"># Inkrementiere den Speicherschritt, aber clippe es auf num_points +1</span>
      <span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">num_points</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">state</span>

    <span class="n">new_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">do_save</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_state</span>

  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HistoryState</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>

<div class="viewcode-block" id="SaveAllHistoryState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveAllHistoryState.html#autopdex.dae.SaveAllHistoryState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SaveAllHistoryState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the SaveAllPolicy.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">t_max</span><span class="p">:</span> <span class="nb">float</span>
  <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">t</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">q</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">current_save_idx</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">Any</span></div>

<div class="viewcode-block" id="SaveAllPolicy"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.SaveAllPolicy.html#autopdex.dae.SaveAllPolicy">[docs]</a><span class="k">class</span> <span class="nc">SaveAllPolicy</span><span class="p">(</span><span class="n">SavePolicy</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Saves data at every accepted time step.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">unpack_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">t_max</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares the history state. Initializes the arrays with NaNs.&quot;&quot;&quot;</span>

    <span class="n">history_t</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">history_q</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">history_user</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">max_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">user_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">user_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">current_save_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">SaveAllHistoryState</span><span class="p">(</span><span class="n">t_max</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">history_t</span><span class="p">,</span> <span class="n">history_q</span><span class="p">,</span> <span class="n">current_save_idx</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">history_user</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save current state.&quot;&quot;&quot;</span>
    <span class="n">state</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">:</span>
      <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">user_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">user_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c1"># Inkrementiere den Speicherschritt, aber clippe es auf max_steps</span>
    <span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">current_save_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">max_steps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HistoryState</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>


<span class="c1">## Step size controler</span>
<div class="viewcode-block" id="StepSizeController"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.StepSizeController.html#autopdex.dae.StepSizeController">[docs]</a><span class="k">class</span> <span class="nc">StepSizeController</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Abstract base class for adaptive step size controllers.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initialize the controller state based on the initial error.</span>

<span class="sd">      Args:</span>
<span class="sd">          initial_error (float): The initial scaled error estimate.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Any: The initial state of the controller.</span>
<span class="sd">      &quot;&quot;&quot;</span>
    <span class="k">pass</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">compute_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Compute the scaling factor `step_scaler` and update the controller state.</span>

<span class="sd">      Args:</span>
<span class="sd">          error (float): The current scaled error estimate.</span>
<span class="sd">          state (Any): The current state of the controller.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Tuple[float, Any]: A tuple containing the scaling factor `step_scaler` and the updated state.</span>
<span class="sd">      &quot;&quot;&quot;</span>
    <span class="k">pass</span>

  <span class="nd">@abstractmethod</span>
  <span class="k">def</span> <span class="nf">check_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Check whether the current step should be accepted.</span>

<span class="sd">      Args:</span>
<span class="sd">          state (Any): The current state of the controller.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Bool: Whether the step should be accepted.</span>
<span class="sd">      &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="PIDControllerState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.PIDControllerState.html#autopdex.dae.PIDControllerState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PIDControllerState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the Proportional-Integral-Derivative Controller.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">step_scaler</span><span class="p">:</span> <span class="nb">float</span>
  <span class="n">e_n</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># error_n</span>
  <span class="n">e_nn</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># error_{n-1}</span>
  <span class="n">accept</span><span class="p">:</span> <span class="nb">bool</span>
  <span class="n">interrupt</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="PIDController"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.PIDController.html#autopdex.dae.PIDController">[docs]</a><span class="k">class</span> <span class="nc">PIDController</span><span class="p">(</span><span class="n">StepSizeController</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Proportional-Integral-Derivative (PID) Step Size Controller.</span>
<span class="sd">  </span>
<span class="sd">  Inspired by https://docs.kidger.site/diffrax/api/stepsize_controller and https://docs.sciml.ai/DiffEqDocs/stable/extras/timestepping/</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PIDController.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.PIDController.html#autopdex.dae.PIDController.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">pcoeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">icoeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="n">dcoeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">limiter</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
               <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the PIDController.</span>

<span class="sd">    Args:</span>
<span class="sd">      pcoeff (float): The coefficient of the proportional part of the step size control.</span>
<span class="sd">      icoeff (float): The coefficient of the integral part of the step size control.</span>
<span class="sd">      dcoeff (float): The coefficient of the derivative part of the step size control.</span>
<span class="sd">      limiter (callable): Limiter function. If None the limiter is set to `1.0 + jnp.arctan(x - 1.0)`.</span>
<span class="sd">      atol (float): Absolute tolerance.</span>
<span class="sd">      rtol (float): Relative tolerance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">limiter</span> <span class="o">=</span> <span class="n">limiter</span> <span class="k">if</span> <span class="n">limiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="n">atol</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="n">rtol</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pcoeff</span> <span class="o">=</span> <span class="n">pcoeff</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">icoeff</span> <span class="o">=</span> <span class="n">icoeff</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dcoeff</span> <span class="o">=</span> <span class="n">dcoeff</span></div>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: Initialization of time increment? See diffrax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PIDControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">e_n</span><span class="o">=</span><span class="n">initial_error</span><span class="p">,</span> <span class="n">e_nn</span><span class="o">=</span><span class="n">initial_error</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">compute_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">atol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atol</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>

    <span class="c1"># Check that all integrators support error estimation (integrators that does not support return None as error)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Error estimation is not supported for the integrator of field &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;!</span><span class="se">\n</span><span class="s2"> Use a different integrator or a time step control that does not require error estimation.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Scaled error estimate</span>
    <span class="n">scaled_error</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">atol</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">rtol</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span>
    <span class="p">}</span>
    <span class="n">scaled_error</span> <span class="o">=</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">scaled_error</span><span class="p">)</span>

    <span class="c1"># Hairer norm</span>
    <span class="n">inv_error_norm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scaled_error</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># PID coefficients</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcoeff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">icoeff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcoeff</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcoeff</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcoeff</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>
    <span class="n">beta3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcoeff</span> <span class="o">/</span> <span class="n">k</span>

    <span class="c1"># PID rule</span>
    <span class="n">step_scaler</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">inv_error_norm</span><span class="p">,</span> <span class="n">beta1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">e_n</span><span class="p">,</span> <span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">e_nn</span><span class="p">,</span> <span class="n">beta3</span><span class="p">)</span>

    <span class="c1"># Handle zero error</span>
    <span class="n">step_scaler</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">inv_error_norm</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">step_scaler</span><span class="p">)</span>

    <span class="c1"># Apply limiter function</span>
    <span class="n">step_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limiter</span><span class="p">(</span><span class="n">step_scaler</span><span class="p">)</span>

    <span class="c1"># Update state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">PIDControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_n</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_nn</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">accept</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">)</span>

    <span class="c1"># Update previous errors if step is accepted</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_accept</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span><span class="o">.</span><span class="n">accept</span>

    <span class="k">def</span> <span class="nf">do_accept</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">PIDControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">inv_error_norm</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_n</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">accept</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_reject</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">PIDControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_n</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_nn</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">accept</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">accepted</span><span class="p">,</span> <span class="n">do_accept</span><span class="p">,</span> <span class="n">do_reject</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">check_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PIDControllerState</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_n</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">e_nn</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">)</span></div>

<div class="viewcode-block" id="CSSControllerState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.CSSControllerState.html#autopdex.dae.CSSControllerState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CSSControllerState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the Constant Step Size Controller.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">step_scaler</span><span class="p">:</span> <span class="nb">float</span>
  <span class="n">accept</span><span class="p">:</span> <span class="nb">bool</span>
  <span class="n">interrupt</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="ConstantStepSizeController"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ConstantStepSizeController.html#autopdex.dae.ConstantStepSizeController">[docs]</a><span class="k">class</span> <span class="nc">ConstantStepSizeController</span><span class="p">(</span><span class="n">StepSizeController</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Constant Step Size Controller.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantStepSizeController.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.ConstantStepSizeController.html#autopdex.dae.ConstantStepSizeController.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span></div>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CSSControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">compute_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">check_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="c1"># Give warning in case not converged and not already warned</span>
    <span class="k">def</span> <span class="nf">send_warning</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Root solver did not converge, but stepsize controller can not reduce step size!&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">True</span>

    <span class="n">do_nothing</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span>
    <span class="n">warn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">converged</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">))</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">send_warning</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CSSControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">converged</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">interrupt</span><span class="p">)</span></div>

<div class="viewcode-block" id="RootIterationControllerState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.RootIterationControllerState.html#autopdex.dae.RootIterationControllerState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RootIterationControllerState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the Root Iteration Controller.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">step_scaler</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Scaling factor for the step size</span>
  <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span>
  <span class="n">accept</span><span class="p">:</span> <span class="nb">bool</span>
  <span class="n">interrupt</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="RootIterationController"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.RootIterationController.html#autopdex.dae.RootIterationController">[docs]</a><span class="k">class</span> <span class="nc">RootIterationController</span><span class="p">(</span><span class="n">StepSizeController</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Root Iteration Controller for adjusting step size based on number of root solver iterations.</span>
<span class="sd">  </span>
<span class="sd">  Tries to achieve a target number of Newton iterations by adjusting the step size.</span>
<span class="sd">  Does not consider possible error estimates. Maximal and minimal step sizes can be set.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RootIterationController.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.RootIterationController.html#autopdex.dae.RootIterationController.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">target_niters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
               <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
               <span class="n">max_step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e20</span><span class="p">,</span>
               <span class="n">min_step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the RootIterationController.</span>

<span class="sd">    Args:</span>
<span class="sd">      target_niters (int): Desired number of Newton iterations.</span>
<span class="sd">      gamma (float): Proportionality factor for step size adjustment.</span>
<span class="sd">      max_step_size (float): Maximum allowable step size.</span>
<span class="sd">      min_step_size (float): Minimum allowable step size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_niters</span> <span class="o">=</span> <span class="n">target_niters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_step_size</span> <span class="o">=</span> <span class="n">max_step_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_step_size</span> <span class="o">=</span> <span class="n">min_step_size</span></div>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RootIterationControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">compute_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="c1"># Proportional control based on the deviation from target_niters</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_niters</span> <span class="o">-</span> <span class="n">num_iterations</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_niters</span><span class="p">)</span>

    <span class="c1"># If not converged, devide step size by 2</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">converged</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>

    <span class="c1"># Change step size</span>
    <span class="n">dt_old</span> <span class="o">=</span> <span class="n">dt</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">correction</span>

    <span class="c1"># Limit step size to bounds</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_step_size</span><span class="p">)</span>

    <span class="c1"># Recalculate scaling factor</span>
    <span class="n">step_scaler</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dt_old</span>

    <span class="c1"># Update state</span>
    <span class="k">return</span> <span class="n">RootIterationControllerState</span><span class="p">(</span><span class="n">step_scaler</span><span class="o">=</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">accept</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">check_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="c1"># Give warning in case not converged and step size can not be reduced further</span>
    <span class="k">def</span> <span class="nf">send_warning</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Root solver did not converge, but minimum step_size is reached!&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">True</span>

    <span class="n">do_nothing</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">interrupt</span>
    <span class="n">warn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">converged</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step_size</span><span class="p">)),</span>
                           <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">interrupt</span><span class="p">))</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">send_warning</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RootIterationControllerState</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">step_scaler</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">)</span></div>


<span class="c1">## Root solvers</span>
<div class="viewcode-block" id="RootSolverResult"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.RootSolverResult.html#autopdex.dae.RootSolverResult">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RootSolverResult</span><span class="p">:</span>
  <span class="n">root</span><span class="p">:</span> <span class="n">Any</span>
  <span class="n">num_iterations</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">converged</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="newton_solver"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.newton_solver.html#autopdex.dae.newton_solver">[docs]</a><span class="k">def</span> <span class="nf">newton_solver</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">,</span>
    <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">damping_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">tangent_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lin_solve_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">constrained_dofs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">constrained_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">termination_mode</span><span class="o">=</span><span class="s1">&#39;residual&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newton-Raphson solver to find a root of F(x)=0.</span>

<span class="sd">    Args:</span>
<span class="sd">      func: Function F(x) whose zero is sought.</span>
<span class="sd">      x0: Initial guess.</span>
<span class="sd">      atol: Absolute tolerance.</span>
<span class="sd">      max_iter: Maximum number of iterations.</span>
<span class="sd">      tangent_fun: Function to compute the Jacobian. (Default: jax.jacfwd(func))</span>
<span class="sd">      lin_solve_fun: Function to solve the linear system. (Default: jnp.linalg.solve)</span>
<span class="sd">      constrained_dofs: Boolean mask for fixed degrees of freedom.</span>
<span class="sd">      constrained_values: Fixed values for constrained DOFs.</span>
<span class="sd">      verbose: If &gt;=1, prints the residual norm each iteration.</span>
<span class="sd">      termination_mode: &#39;residual&#39; uses the residual norm; &#39;update&#39; uses the update size.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A RootSolverResult dataclass with fields:</span>
<span class="sd">        - .root: the computed solution,</span>
<span class="sd">        - .num_iterations: number of updates performed,</span>
<span class="sd">        - .converged: convergence flag.</span>
<span class="sd">    &quot;&quot;&quot;</span>

  <span class="c1"># Set constraints if provided.</span>
  <span class="n">free_dofs</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="n">constrained_dofs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">free_dofs</span> <span class="o">=</span> <span class="o">~</span><span class="n">constrained_dofs</span>
    <span class="k">if</span> <span class="n">constrained_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;constrained_values must be provided if constrained_dofs is not None!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">constrained_dofs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;constrained_dofs must have the same shape as x0!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">constrained_values</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;constrained_values must have the same shape as x0!&quot;</span><span class="p">)</span>
    <span class="c1"># Enforce constraints in the initial guess.</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constrained_dofs</span><span class="p">,</span> <span class="n">constrained_values</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">lin_solve_fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">constrained_dofs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">lin_solve_fun</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">lin_solve_fun</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">J_mod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constrained_dofs</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J_mod</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

  <span class="n">use_residual</span> <span class="o">=</span> <span class="n">termination_mode</span> <span class="o">==</span> <span class="s1">&#39;residual&#39;</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">fx_norm</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">update_fn</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
      <span class="c1"># Apply boundary conditions</span>
      <span class="n">x_mod</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">constrained_dofs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constrained_dofs</span><span class="p">,</span> <span class="n">constrained_values</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

      <span class="c1"># Residual and tangent</span>
      <span class="k">if</span> <span class="n">tangent_fun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x_mod</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">tangent_fun</span><span class="p">(</span><span class="n">x_mod</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Option useing jvp + vmap.</span>
        <span class="c1"># Create the standard basis for the tangent space.</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">x_mod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Map jax.jvp over the identity basis.</span>
        <span class="c1"># Each call returns (f(x_mod), f&#39;(x_mod) @ v)</span>
        <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">x_mod</span><span class="p">,),</span> <span class="p">(</span><span class="n">v</span><span class="p">,)))(</span><span class="n">eye</span><span class="p">)</span>
        <span class="c1"># All primals are identical; extract the first one.</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">primals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Each tangent is one row of the Jacobian, so we transpose.</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">tangents</span><span class="o">.</span><span class="n">T</span>

      <span class="c1"># Apply boundary conditions</span>
      <span class="n">fx_mod</span> <span class="o">=</span> <span class="n">fx</span> <span class="k">if</span> <span class="n">constrained_dofs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constrained_dofs</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">fx</span><span class="p">)</span>
      <span class="n">fx_norm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">fx_mod</span><span class="p">)</span>

      <span class="c1"># Stop newton iterations if NaN or Inf values are encountered.</span>
      <span class="n">stop</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fx_norm</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">fx_norm</span><span class="p">)))</span>

      <span class="c1"># In &#39;residual&#39; mode, only call the linear solver if fx_norm &gt;= atol.</span>
      <span class="k">if</span> <span class="n">use_residual</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
          <span class="c1"># Ensure one iteration in case of constrained dofs</span>
          <span class="n">fx_norm</span> <span class="o">&lt;</span> <span class="n">atol</span> <span class="k">if</span> <span class="n">constrained_dofs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">fx_norm</span> <span class="o">&lt;</span> <span class="n">atol</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
          <span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_mod</span><span class="p">),</span>
          <span class="k">lambda</span><span class="p">:</span> <span class="n">lin_solve_fun</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="o">-</span><span class="n">fx_mod</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">lin_solve_fun</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="o">-</span><span class="n">fx_mod</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">)</span>

      <span class="n">x_new</span> <span class="o">=</span> <span class="n">x_mod</span> <span class="o">+</span> <span class="n">damping_factor</span> <span class="o">*</span> <span class="n">delta</span>

      <span class="n">new_converged</span> <span class="o">=</span> <span class="n">fx_norm</span> <span class="o">&lt;</span> <span class="n">atol</span> <span class="k">if</span> <span class="n">use_residual</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">atol</span>
      <span class="n">new_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># increment only when update_fn is executed</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Print using the update counter rather than the loop counter.</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Iteration </span><span class="si">{iter}</span><span class="s2">, Residual norm: </span><span class="si">{res}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">fx_norm</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="k">return</span> <span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">new_count</span><span class="p">,</span> <span class="n">fx_norm</span><span class="p">,</span> <span class="n">new_converged</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

    <span class="c1"># If already converged, carry the state unchanged.</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">converged</span><span class="p">,</span> <span class="n">stop</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="n">update_fn</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_state</span>

  <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

  <span class="c1"># Define condition for while_loop: iterate while iterations remain and not all instances are converged or stopped.</span>
  <span class="k">def</span> <span class="nf">cond_fn</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">max_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">converged</span><span class="p">,</span> <span class="n">stop</span><span class="p">))))</span>

  <span class="n">final_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fn</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">body</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">state</span><span class="p">)</span>
  <span class="n">x_final</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">final_state</span>

  <span class="c1"># In case of invalid values, fallback to the initial guess and stop the gradients.</span>
  <span class="n">x_final</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="o">~</span><span class="n">conv</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_final</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x_final</span><span class="p">))),</span>
                      <span class="n">x0</span><span class="p">,</span> <span class="n">x_final</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">RootSolverResult</span><span class="p">(</span><span class="n">x_final</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span></div>


<span class="c1">## Time stepping manager</span>

<div class="viewcode-block" id="TimeSteppingManagerState"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeSteppingManagerState.html#autopdex.dae.TimeSteppingManagerState">[docs]</a><span class="nd">@jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">register_dataclass</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TimeSteppingManagerState</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  State for the TimeSteppingManager.</span>

<span class="sd">  Attributes:</span>
<span class="sd">      q (dict[str, jnp.ndarray]): Final state variables after time stepping.</span>
<span class="sd">      settings (dict[str, Any]): Simulation settings after the run.</span>
<span class="sd">      history (Any): Recorded history data (if a save policy is used).</span>
<span class="sd">      num_steps (int): Total number of steps taken.</span>
<span class="sd">      num_accepted (int): Number of accepted time steps.</span>
<span class="sd">      num_rejected (int): Number of rejected time steps.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">q</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
  <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
  <span class="n">history</span><span class="p">:</span> <span class="n">Any</span>
  <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">num_accepted</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">num_rejected</span><span class="p">:</span> <span class="nb">int</span></div>

<div class="viewcode-block" id="TimeSteppingManager"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeSteppingManager.html#autopdex.dae.TimeSteppingManager">[docs]</a><span class="k">class</span> <span class="nc">TimeSteppingManager</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Manages the time stepping procedure for a simulation using multi-stage integration schemes.</span>

<span class="sd">  This class orchestrates the simulation by coordinating various components such as:</span>
<span class="sd">    - Time integrators for different fields,</span>
<span class="sd">    - A root solver for implicit equations,</span>
<span class="sd">    - An adaptive step size controller,</span>
<span class="sd">    - A save policy for recording history,</span>
<span class="sd">    - Pre-step and post-step update functions for custom processing.</span>

<span class="sd">  The manager initializes the simulation state from given degrees of freedom (DOFs) and then runs a loop</span>
<span class="sd">  over a specified number of time steps. At each step, it computes the new state using multi-stage methods,</span>
<span class="sd">  applies error control and adaptive time stepping, and optionally records simulation history. The final state</span>
<span class="sd">  along with simulation statistics is returned.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeSteppingManager.__init__"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeSteppingManager.html#autopdex.dae.TimeSteppingManager.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">static_settings</span><span class="p">,</span>
      <span class="n">settings</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;current time&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
      <span class="n">root_solver</span><span class="o">=</span><span class="n">newton_solver</span><span class="p">,</span>
      <span class="n">save_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">step_size_controller</span><span class="o">=</span><span class="n">ConstantStepSizeController</span><span class="p">(),</span>
      <span class="n">postprocessing_fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="p">{},</span>
      <span class="n">pre_step_updates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">post_step_updates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span> <span class="o">=</span> <span class="n">static_settings</span><span class="p">[</span><span class="s1">&#39;time integrators&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">root_solver</span> <span class="o">=</span> <span class="n">root_solver</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_time_derivs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">integrator</span><span class="o">.</span><span class="n">num_derivs</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">integrator</span><span class="o">.</span><span class="n">num_steps</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span> <span class="o">=</span> <span class="n">save_policy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_size_controller</span> <span class="o">=</span> <span class="n">step_size_controller</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_fun</span> <span class="o">=</span> <span class="n">postprocessing_fun</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span> <span class="o">=</span> <span class="n">static_settings</span>
    <span class="k">if</span> <span class="n">pre_step_updates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># Update the current time</span>
      <span class="k">def</span> <span class="nf">pre_step_updates</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;current time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">settings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pre_step_updates</span> <span class="o">=</span> <span class="n">pre_step_updates</span>
    <span class="k">if</span> <span class="n">post_step_updates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">post_step_updates</span><span class="p">(</span><span class="n">q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_step_updates</span> <span class="o">=</span> <span class="n">post_step_updates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">static_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_tree_flatten</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">aux_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">integrators</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">num_time_derivs</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_solver</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">save_policy</span><span class="p">,</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">step_size_controller</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">postprocessing_fun</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">static_settings</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pre_step_updates</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">post_step_updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">aux_data</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_tree_unflatten</span><span class="p">(</span><span class="n">aux_data</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">TimeSteppingManager</span><span class="p">)</span>
    <span class="p">()</span> <span class="o">=</span> <span class="n">children</span>
    <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">integrators</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">num_time_derivs</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">root_solver</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">save_policy</span><span class="p">,</span>
     <span class="n">obj</span><span class="o">.</span><span class="n">step_size_controller</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">postprocessing_fun</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">static_settings</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
     <span class="n">obj</span><span class="o">.</span><span class="n">pre_step_updates</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">post_step_updates</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux_data</span>
    <span class="k">return</span> <span class="n">obj</span>

  <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dofs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes history for multi-step methods and stores the global DOF structure</span>
<span class="sd">      as a template for unflattening.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q_n</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">dofs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dofs</span><span class="p">}</span>
    <span class="n">q_der_n</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_time_derivs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="o">*</span><span class="n">dofs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dofs</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_global_template</span> <span class="o">=</span> <span class="n">dofs</span>
    <span class="k">return</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span>

  <span class="k">def</span> <span class="nf">_assemble_sparse_tangent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_flat</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">static_settings</span><span class="p">):</span>
    <span class="n">num_domains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">static_settings</span><span class="p">[</span><span class="s2">&quot;assembling mode&quot;</span><span class="p">])</span>
    <span class="n">num_dofs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_template</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">integrated_tangent</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_dofs</span><span class="p">,</span> <span class="n">num_dofs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>

    <span class="c1"># Make sure all assembling modes are &#39;user residual&#39; as it is the only one currently supported</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;user residual&#39;</span>
               <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">static_settings</span><span class="p">[</span><span class="s2">&quot;assembling mode&quot;</span><span class="p">]),</span> <span class="s2">&quot;Only &#39;user residual&#39; assembling mode is supported.&quot;</span>

    <span class="c1"># Loop over all sets of integration points/ domains</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_domains</span><span class="p">):</span>
      <span class="n">integrated_tangent</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_sparse_tangent_domain</span><span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span>
                                                                 <span class="n">static_settings</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">integrated_tangent</span>

  <span class="k">def</span> <span class="nf">_assemble_sparse_tangent_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_flat</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">static_settings</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
    <span class="c1"># Todo: andere modes? e.g. for potential-based problems (like user potentials in assembler)</span>
    <span class="c1"># todo: currently only single stages and blocks possible</span>

    <span class="c1"># Reconstruct global DOF structure from flat vector</span>
    <span class="n">global_dofs</span> <span class="o">=</span> <span class="n">reshape_as</span><span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_template</span><span class="p">)</span>

    <span class="c1"># Get elementwise quantities (model_fun, node coordinates, elem_numbers, connectivity)</span>
    <span class="n">model_fun</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">,</span> <span class="n">elem_numbers</span><span class="p">,</span> <span class="n">connectivity</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">_get_element_quantities</span><span class="p">(</span>
        <span class="n">global_dofs</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">static_settings</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_dofs</span><span class="p">(</span><span class="n">dofs</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>

    <span class="c1"># Calculate the tangent for each element</span>
    <span class="k">def</span> <span class="nf">element_tangent_wrapper</span><span class="p">(</span><span class="n">local_dofs</span><span class="p">,</span> <span class="n">elem_number</span><span class="p">,</span> <span class="n">node_list</span><span class="p">):</span>
      <span class="c1"># Extract local DOFs for the current element</span>
      <span class="n">local_q_n</span> <span class="o">=</span> <span class="n">extract_dofs</span><span class="p">(</span><span class="n">q_n</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">local_q_t_n</span> <span class="o">=</span> <span class="n">extract_dofs</span><span class="p">(</span><span class="n">q_t_n</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">diffable_q_fun</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">local_diffable</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">local_dofs</span><span class="p">:</span>
          <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">local_dofs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">local_q_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">local_q_t_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
          <span class="n">local_diffable</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># todo: handle multiple blocks</span>
        <span class="k">return</span> <span class="n">local_diffable</span>

      <span class="n">local_node_coor</span> <span class="o">=</span> <span class="n">extract_dofs</span><span class="p">(</span><span class="n">x_nodes</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">model_fun</span><span class="p">(</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">local_node_coor</span><span class="p">,</span> <span class="n">elem_number</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">static_settings</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">element_tangent</span><span class="p">(</span><span class="n">elem_number</span><span class="p">,</span> <span class="n">node_list</span><span class="p">):</span>
      <span class="n">local_dofs</span> <span class="o">=</span> <span class="n">extract_dofs</span><span class="p">(</span><span class="n">global_dofs</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">element_tangent_wrapper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">elem_number</span><span class="p">,</span> <span class="n">node_list</span><span class="p">))(</span><span class="n">local_dofs</span><span class="p">)</span>

    <span class="c1"># tangent_contributions = jax.vmap(element_tangent, in_axes=(0, 0))(elem_numbers, connectivity)</span>

    <span class="n">body_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">element_tangent</span><span class="p">(</span><span class="n">elem_numbers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">connectivity</span><span class="p">))</span>
    <span class="n">num_dofs_per_elem</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">eval_shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">body_fun</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tangent_contributions</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">body_fun</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">elem_numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">64000</span><span class="o">/</span><span class="n">num_dofs_per_elem</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">tangent_contributions</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">_get_indices</span><span class="p">(</span><span class="n">connectivity</span><span class="p">,</span> <span class="n">global_dofs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">global_dofs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="n">num_dofs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">global_dofs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">num_dofs</span> <span class="o">=</span> <span class="n">global_dofs</span><span class="o">.</span><span class="n">size</span>

    <span class="n">tangent_matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">BCOO</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">indices</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_dofs</span><span class="p">,</span> <span class="n">num_dofs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tangent_matrix</span>

  <span class="k">def</span> <span class="nf">_multi_stage_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="c1"># Assumption: All integrators have the same number of stages</span>
    <span class="n">num_stages</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">num_stages</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">stage_list</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">stage_list</span>
    <span class="n">stage_positions</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">stage_positions</span>
    <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">stage_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">q_stages</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">num_stages</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="c1"># Run through all stages</span>
    <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">state_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">block_body</span><span class="p">(</span><span class="n">block_number</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
      <span class="n">q_stages</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">state</span>
      <span class="n">current_stages</span> <span class="o">=</span> <span class="n">stage_list</span><span class="p">[</span><span class="n">block_number</span><span class="p">]</span>
      <span class="n">num_coupled_stages</span> <span class="o">=</span> <span class="n">current_stages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">t_stage</span> <span class="o">=</span> <span class="n">t_n</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">stage_positions</span><span class="p">[</span><span class="n">current_stages</span><span class="p">]</span>

      <span class="c1"># Update e.g. boundary conditions and &#39;current time&#39; for the assembler for PDE problems</span>
      <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_step_updates</span><span class="p">(</span><span class="n">t_stage</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">settings</span><span class="p">)</span>

      <span class="c1"># Getting some settings for solver and tangent specific settings</span>
      <span class="n">dirichlet_dofs</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dirichlet dofs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
      <span class="n">dirichlet_conditions</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dirichlet conditions&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">dirichlet_dofs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">dirichlet_conditions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Constrained values must be provided if constrained dofs are given.&quot;</span>
        <span class="n">dirichlet_dofs</span> <span class="o">=</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">dirichlet_dofs</span><span class="p">)</span>
        <span class="n">dirichlet_conditions</span> <span class="o">=</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">dirichlet_conditions</span><span class="p">)</span>
      <span class="n">free_dofs</span> <span class="o">=</span> <span class="o">~</span><span class="n">dirichlet_dofs</span> <span class="k">if</span> <span class="n">dirichlet_dofs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

      <span class="n">solver_backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver backend&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
      <span class="n">solver_subtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
      <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">impl_diff_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit diff mode&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">)</span>

      <span class="c1"># Custom tangent via assembling for sparse problems</span>
      <span class="n">tangent_fun</span> <span class="o">=</span> <span class="kc">None</span>

      <span class="c1"># Todo: make it diffable via custom root wrapper as in solver.adaptive_load_stepping</span>
      <span class="k">if</span> <span class="n">solver_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lin_solve_fun</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">elif</span> <span class="n">solver_backend</span> <span class="o">==</span> <span class="s1">&#39;pardiso&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">lin_solve_fun</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">):</span>
          <span class="n">callback_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">linear_solve_pardiso</span><span class="p">(</span>
              <span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver_subtype</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">free_dofs</span><span class="o">=</span><span class="n">free_dofs</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">pure_callback</span><span class="p">(</span><span class="n">callback_fun</span><span class="p">,</span>
                                   <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                   <span class="n">mat</span><span class="p">,</span>
                                   <span class="n">rhs</span><span class="p">,</span>
                                   <span class="n">free_dofs</span><span class="p">,</span>
                                   <span class="n">vmap_method</span><span class="o">=</span><span class="s1">&#39;sequential&#39;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">solver_backend</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">lin_solve_fun</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">):</span>
          <span class="n">callback_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">free_dofs</span><span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">linear_solve_scipy</span><span class="p">(</span>
              <span class="n">mat</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">free_dofs</span><span class="o">=</span><span class="n">free_dofs</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver_subtype</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">pure_callback</span><span class="p">(</span><span class="n">callback_fun</span><span class="p">,</span>
                                   <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                   <span class="n">mat</span><span class="p">,</span>
                                   <span class="n">rhs</span><span class="p">,</span>
                                   <span class="n">free_dofs</span><span class="p">,</span>
                                   <span class="n">vmap_method</span><span class="o">=</span><span class="s1">&#39;sequential&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown solver backend: </span><span class="si">{</span><span class="n">solver_backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="c1"># @partial(jax.jit, inline=True)</span>
      <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
      <span class="k">def</span> <span class="nf">residual_fun_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">):</span>
        <span class="c1"># print(&quot;Traced residual&quot;)</span>
        <span class="n">q_stages_current</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">q_stages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_coupled_stages</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">inner_body</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">q_sc</span><span class="p">):</span>
          <span class="n">q_s</span> <span class="o">=</span> <span class="n">reshape_as</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">template</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">q_sc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_sc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">current_stages</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q_s</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
          <span class="k">return</span> <span class="n">q_sc</span>

        <span class="k">if</span> <span class="n">num_coupled_stages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">q_stages_current</span> <span class="o">=</span> <span class="n">inner_body</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_stages_current</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">q_stages_current</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_coupled_stages</span><span class="p">,</span> <span class="n">inner_body</span><span class="p">,</span> <span class="n">q_stages_current</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_residual_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
          <span class="n">q_ts</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value_and_derivatives</span><span class="p">(</span><span class="n">q_stages_current</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_t_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">q_ts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">)</span>

          <span class="k">def</span> <span class="nf">diffable_q_fun</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q_ts</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">q_ts</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="p">[</span><span class="s1">&#39;dae&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;call pde&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">assembler</span><span class="o">.</span><span class="n">assemble_residual</span><span class="p">(</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="p">))</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="p">[</span><span class="s1">&#39;dae&#39;</span><span class="p">](</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">_residual_fun</span><span class="p">(</span><span class="n">current_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_stage</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">residual_fun_vmap</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_residual_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">residual_fun_vmap</span><span class="p">(</span><span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

      <span class="n">q_flat</span> <span class="o">=</span> <span class="n">dict_flatten</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
      <span class="n">q_flat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">q_flat</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="p">(</span><span class="n">num_coupled_stages</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

      <span class="c1"># Root solve</span>
      <span class="k">if</span> <span class="n">solver_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">root_solve</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
          <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_solver</span><span class="p">(</span>
                    <span class="n">fun</span><span class="p">,</span>
                    <span class="n">x0</span><span class="p">,</span>
                    <span class="n">tangent_fun</span><span class="o">=</span><span class="n">tangent_fun</span><span class="p">,</span>
                    <span class="n">constrained_dofs</span><span class="o">=</span><span class="n">dirichlet_dofs</span><span class="p">,</span>
                    <span class="n">constrained_values</span><span class="o">=</span><span class="n">dirichlet_conditions</span><span class="p">,</span>
                    <span class="n">lin_solve_fun</span><span class="o">=</span><span class="n">lin_solve_fun</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>

          <span class="n">float_iterations</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">num_iterations</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
          <span class="n">float_conv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">float_conv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">impl_diff_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">):</span>
          <span class="c1"># Todo: doesn&#39;t work for derivatives w.r.t. BCs, use custom_root decorator instead (has to be extended for dense matrices)</span>
          <span class="k">assert</span> <span class="n">dirichlet_dofs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Dirichlet BCs are not supported in implicit diff modes &#39;forward&#39;, &#39;reverse&#39;, &#39;backward&#39;. Use None instead or use sparse solvers, e.g. &#39;pardiso&#39; or &#39;scipy&#39;.&quot;</span>

          <span class="n">q_root</span><span class="p">,</span> <span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">float_converged</span><span class="p">)</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">custom_root</span><span class="p">(</span>
            <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">residual_fun_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">),</span>
            <span class="n">initial_guess</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">q_flat</span><span class="p">),</span>
            <span class="n">solve</span><span class="o">=</span><span class="n">root_solve</span><span class="p">,</span>
            <span class="n">tangent_solve</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span>
            <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># Works, but may be not as efficient as with custom_root. Can sometimes produce nans in reverse mode.</span>
          <span class="n">q_root</span><span class="p">,</span> <span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">float_converged</span><span class="p">)</span> <span class="o">=</span> <span class="n">root_solve</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">residual_fun_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">),</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">q_flat</span><span class="p">))</span>

      <span class="k">elif</span> <span class="n">solver_backend</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pardiso&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;pyamg&#39;</span><span class="p">,</span> <span class="s1">&#39;petsc&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="p">[</span><span class="s1">&#39;dae&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;call pde&#39;</span><span class="p">,</span> <span class="s2">&quot;Only &#39;call pde&#39; mode is supported for sparse solvers.&quot;</span>

        <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
        <span class="k">def</span> <span class="nf">tangent_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">):</span>
          <span class="c1"># print(&quot;Traced tangent&quot;)</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_sparse_tangent</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_settings</span><span class="p">)</span>

        <span class="c1"># Implicit diff of newton solver</span>
        <span class="nd">@implicit_diff</span><span class="o">.</span><span class="n">custom_root</span><span class="p">(</span>
          <span class="n">residual_fun</span><span class="o">=</span><span class="n">residual_fun_flat</span><span class="p">,</span>
          <span class="n">mat_fun</span><span class="o">=</span><span class="n">tangent_fun</span><span class="p">,</span>
          <span class="n">solve</span><span class="o">=</span><span class="n">lin_solve_fun</span><span class="p">,</span>
          <span class="n">free_dofs</span><span class="o">=</span><span class="n">free_dofs</span><span class="p">,</span>
          <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="n">mode</span><span class="o">=</span><span class="n">impl_diff_mode</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">root_solve</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">):</span>
          <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_solver</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">residual_fun_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">),</span>
                <span class="n">x0</span><span class="p">,</span>
                <span class="n">tangent_fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tangent_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">),</span>
                <span class="n">constrained_dofs</span><span class="o">=</span><span class="n">dirichlet_dofs</span><span class="p">,</span>
                <span class="n">constrained_values</span><span class="o">=</span><span class="n">dirichlet_conditions</span><span class="p">,</span>
                <span class="n">lin_solve_fun</span><span class="o">=</span><span class="n">lin_solve_fun</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

          <span class="n">float_iterations</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">num_iterations</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
          <span class="n">float_conv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">float_conv</span><span class="p">)</span>

        <span class="n">q_root</span><span class="p">,</span> <span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">float_converged</span><span class="p">)</span> <span class="o">=</span> <span class="n">root_solve</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">q_flat</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_t_n</span><span class="p">,</span> <span class="n">current_stages</span><span class="p">,</span> <span class="n">t_stage</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">dirichlet_conditions</span><span class="p">,</span> <span class="n">dirichlet_dofs</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown solver backend: </span><span class="si">{</span><span class="n">solver_backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="n">num_iterations</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_iterations</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">num_iterations</span><span class="p">)</span>
      <span class="n">converged</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float_converged</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="n">converged</span><span class="p">)</span>
      <span class="n">q_root</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q_root</span><span class="p">,</span> <span class="p">(</span><span class="n">num_coupled_stages</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

      <span class="k">def</span> <span class="nf">update_body</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">q_stg</span><span class="p">):</span>
        <span class="n">q_s</span> <span class="o">=</span> <span class="n">reshape_as</span><span class="p">(</span><span class="n">q_root</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
          <span class="n">q_stg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_stg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">current_stages</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q_s</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">q_stg</span>

      <span class="k">if</span> <span class="n">num_coupled_stages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">q_stages</span> <span class="o">=</span> <span class="n">update_body</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">q_stages</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_coupled_stages</span><span class="p">,</span> <span class="n">update_body</span><span class="p">,</span> <span class="n">q_stages</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">q_stages</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">q_stages</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">block_body</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state_init</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">q_stages</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">block_body</span><span class="p">,</span> <span class="n">state_init</span><span class="p">)</span>

    <span class="c1"># Call integrators for updating the solution and derivatives</span>
    <span class="n">q_n1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">q_t_n1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">q_n1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_t_n1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">q_stages</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_t_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">error_estimate</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">_error_estimate</span><span class="p">(</span><span class="n">q_stages</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_t_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">q_n1</span><span class="p">,</span> <span class="n">q_t_n1</span><span class="p">,</span> <span class="n">error_estimate</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span>

<div class="viewcode-block" id="TimeSteppingManager.run"><a class="viewcode-back" href="../../_autosummary/autopdex.dae.TimeSteppingManager.run.html#autopdex.dae.TimeSteppingManager.run">[docs]</a>  <span class="nd">@jit_with_docstring</span><span class="p">(</span><span class="n">static_argnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_time_steps&#39;</span><span class="p">])</span>
  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">dt0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current time&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the time stepping loop for the simulation.</span>

<span class="sd">    This method performs the following operations:</span>
<span class="sd">      1. Verifies that all time integrators are compatible (i.e., they have the same number of stages,</span>
<span class="sd">         identical stage positions, and stage lists).</span>
<span class="sd">      2. Initializes simulation variables including the initial DOFs, time (t), step size (dt), and history state.</span>
<span class="sd">      3. Iteratively performs time steps using a multi-stage integration method:</span>
<span class="sd">           - Updates state with pre-step modifications.</span>
<span class="sd">           - Computes the new state and derivative estimates using the multi-stage step procedure.</span>
<span class="sd">           - Estimates the error and uses the step size controller to adjust dt.</span>
<span class="sd">           - Accepts or rejects the time step based on convergence criteria.</span>
<span class="sd">           - Optionally saves the current state using the save policy.</span>
<span class="sd">           - Performs post-step updates to settings.</span>
<span class="sd">      4. Continues the loop until the simulation time reaches t_max or the maximum number of time steps is reached.</span>
<span class="sd">      5. Finalizes and returns the simulation state along with statistics such as the number of accepted</span>
<span class="sd">         and rejected steps.</span>

<span class="sd">    Args:</span>
<span class="sd">        dofs (dict[str, jnp.ndarray]): Initial degrees of freedom for the simulation.</span>
<span class="sd">        dt0 (float): Initial time step size.</span>
<span class="sd">        t_max (float): Maximum simulation time.</span>
<span class="sd">        num_time_steps (int): Maximum number of time steps to perform.</span>
<span class="sd">        settings (dict[str, Any]): Dictionary containing dynamic simulation settings. Default is {&#39;current time&#39;: 0.0}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        TimeSteppingManagerState: An object containing the final state (q), updated settings, simulation history, and step statistics (total steps, accepted steps, rejected steps).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check whether time integrators are compatible</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">num_stages</span> <span class="o">==</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">num_stages</span> <span class="k">for</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>\
      <span class="s2">&quot;Number of stages must be the same for all fields.&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">stage_positions</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">stage_positions</span><span class="p">)</span> <span class="k">for</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>\
      <span class="s2">&quot;Stage positions must be the same for all fields.&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">stage_list</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">stage_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>\
      <span class="s2">&quot;Stage list must be the same for all fields.&quot;</span>

    <span class="c1"># Alphabetic keywords</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">dofs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dofs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;The keys of the DOFs must be alphabetically sorted.&quot;</span>

    <span class="c1"># Some initializations</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">dofs</span>
    <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">controler_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size_controller</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Todo: get optional start values for derivatives for higher order problems. currently just set to zero...</span>

    <span class="k">def</span> <span class="nf">diffable_q_fun</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_der_n</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_fun</span><span class="p">(</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
    <span class="n">history_state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">history_state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span><span class="o">.</span><span class="n">save_step</span><span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Prepare the function for one time step</span>
    <span class="k">def</span> <span class="nf">loop_body</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">step_fun</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">history_state</span><span class="p">,</span> <span class="n">controler_state</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">last_printed</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t_n</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t_n</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q_n</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="c1"># Run step</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_step_updates</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">q_der</span><span class="p">,</span> <span class="n">error_estimate</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multi_stage_step</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="c1"># Call time step controler</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">integrator</span><span class="o">.</span><span class="n">order</span> <span class="k">for</span> <span class="n">integrator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">controler_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size_controller</span><span class="o">.</span><span class="n">compute_scaler</span><span class="p">(</span>
          <span class="n">error_estimate</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">controler_state</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
          <span class="p">)</span>
        <span class="n">controler_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size_controller</span><span class="o">.</span><span class="n">check_accept</span><span class="p">(</span><span class="n">controler_state</span><span class="p">,</span> <span class="n">converged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Here the step size controling logic is not taken into account for the derivatives</span>
        <span class="c1"># Todo: check whether integrators support changing the step size</span>
        <span class="n">controler_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">controler_state</span><span class="p">)</span>
        <span class="n">dt_scaler</span> <span class="o">=</span> <span class="n">controler_state</span><span class="o">.</span><span class="n">step_scaler</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">controler_state</span><span class="o">.</span><span class="n">accept</span>
        <span class="n">interrupt</span> <span class="o">=</span> <span class="n">controler_state</span><span class="o">.</span><span class="n">interrupt</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">interrupt</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">do_accept</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
          <span class="c1"># Update history data and user-defined postprocessing data and adjust step size</span>

          <span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_a</span><span class="p">,</span> <span class="n">num_r</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">q_der_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">q_der_n</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">q_der_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_der_n</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q_der</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

          <span class="k">def</span> <span class="nf">diffable_q_fun</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">discrete_value_with_derivatives</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">q_der</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

          <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_fun</span><span class="p">(</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
          <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_step_updates</span><span class="p">(</span><span class="n">diffable_q_fun</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
          <span class="n">history_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span><span class="o">.</span><span class="n">save_step</span><span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span> \
                          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">history_state</span>

          <span class="n">dt</span> <span class="o">=</span> <span class="n">dt_scaler</span> <span class="o">*</span> <span class="n">dt</span>
          <span class="n">t_n</span> <span class="o">=</span> <span class="n">t</span>

          <span class="k">return</span> <span class="n">history_state</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_r</span><span class="p">,</span> <span class="n">settings</span>

        <span class="k">def</span> <span class="nf">do_reject</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
          <span class="c1"># Return to old step and reduce step size</span>
          <span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_a</span><span class="p">,</span> <span class="n">num_r</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
          <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">dt</span>
          <span class="n">dt</span> <span class="o">=</span> <span class="n">dt_scaler</span> <span class="o">*</span> <span class="n">dt</span>
          <span class="k">return</span> <span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_a</span><span class="p">,</span> <span class="n">num_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="n">history_state</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="n">do_accept</span><span class="p">,</span> <span class="n">do_reject</span><span class="p">,</span>
            <span class="p">(</span><span class="n">history_state</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>

        <span class="c1"># # debug accept/reject logic</span>
        <span class="c1"># jax.debug.print(&quot;Accept: {x}&quot;, x=accept, ordered=True)</span>
        <span class="c1"># jax.debug.print(&quot;dt: {x}&quot;, x=dt, ordered=True)</span>
        <span class="c1"># jax.debug.print(&quot;t: {x}&quot;, x=t, ordered=True)</span>
        <span class="c1"># jax.debug.print(&quot;t_n: {x}&quot;, x=t_n, ordered=True)</span>
        <span class="c1"># jax.debug.print(&quot;q: {x}&quot;, x=q, ordered=True)</span>
        <span class="c1"># jax.debug.print(&quot;q_n: {x}&quot;, x=q_n, ordered=True)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">t_max</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
          <span class="n">should_print</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">progress</span> <span class="o">-</span> <span class="n">last_printed</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

          <span class="k">def</span> <span class="nf">print_and_update</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Progress: </span><span class="si">{a}</span><span class="s2">%, Time: </span><span class="si">{b:.2e}</span><span class="s2">, accepted step: </span><span class="si">{d}</span><span class="s2">, dt: </span><span class="si">{c:.2e}</span><span class="s2">, iterations: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">a</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                            <span class="n">b</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">c</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                            <span class="n">d</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
                            <span class="n">e</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">,</span>
                            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">progress</span>

          <span class="n">last_printed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">should_print</span><span class="p">,</span> <span class="n">print_and_update</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">last_printed</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_n</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">history_state</span><span class="p">,</span> <span class="n">controler_state</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">last_printed</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">state</span>

      <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">t_max</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">interrupt</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">interrupt</span><span class="p">)),</span> <span class="n">step_fun</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

      <span class="c1"># In case of interruption, set all values in q to nan</span>
      <span class="n">interrupt</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span>
      <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span>
               <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">interrupt</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">x</span><span class="p">)),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
               <span class="o">*</span><span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

      <span class="k">return</span> <span class="n">state</span>

    <span class="c1"># Run time stepping loop</span>
    <span class="n">num_accepted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_rejected</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_n</span><span class="p">,</span> <span class="n">q_der_n</span><span class="p">,</span> <span class="n">history_state</span><span class="p">,</span> <span class="n">controler_state</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_time_steps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">final_state</span> <span class="o">=</span> <span class="n">loop_body</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">final_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="p">,</span> <span class="n">loop_body</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">history_state</span><span class="p">,</span> <span class="n">controler_state</span><span class="p">,</span> <span class="n">num_accepted</span><span class="p">,</span> <span class="n">num_rejected</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">final_state</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_max</span><span class="p">),</span>
                  <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps reached before t_max!&quot;</span><span class="p">),</span>
                  <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">history_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">history_state</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">history_state</span>

    <span class="k">return</span> <span class="n">TimeSteppingManagerState</span><span class="p">(</span>
        <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
        <span class="n">history</span><span class="o">=</span><span class="n">history_state</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_accepted</span> <span class="o">+</span> <span class="n">num_rejected</span><span class="p">,</span>
        <span class="n">num_accepted</span><span class="o">=</span><span class="n">num_accepted</span><span class="p">,</span>
        <span class="n">num_rejected</span><span class="o">=</span><span class="n">num_rejected</span><span class="p">,</span>
    <span class="p">)</span></div></div>

<span class="c1"># Register as pytree node in order to be able to jit the methods</span>
<span class="n">tree_util</span><span class="o">.</span><span class="n">register_pytree_node</span><span class="p">(</span><span class="n">TimeSteppingManager</span><span class="p">,</span> <span class="n">TimeSteppingManager</span><span class="o">.</span><span class="n">_tree_flatten</span><span class="p">,</span>
                               <span class="n">TimeSteppingManager</span><span class="o">.</span><span class="n">_tree_unflatten</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tobias Bode.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>